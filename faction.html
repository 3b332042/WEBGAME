<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8" />
    <title>‰øÆ‰ªôÂÆóÈñÄÂ†¥ÊôØ ‚Äì ÂäüÊ≥ïÈñ£ / Ê¶ÆË≠ΩÂ†Ç / ‰ªôÈùàÊ±†</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            margin: 0;
            height: 100vh;
            overflow: hidden;
            font-family: "Noto Sans TC", "Microsoft JhengHei", system-ui, sans-serif;
            background: radial-gradient(circle at top, #f5f3ea 0, #e5e0d3 35%, #d0cabd 100%);
        }

        /* ===== Êï¥È´îÂ†¥ÊôØ ===== */
        .scene {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        /* ‚≠ê ËøîÂõûÊåâÈàï */
        .back-btn {
            position: absolute;
            top: 18px;
            left: 26px;
            padding: 6px 18px;
            border-radius: 18px;
            background: rgba(26, 18, 16, 0.78);
            color: #f6e7c6;
            border: 1px solid rgba(246, 231, 198, 0.85);
            cursor: pointer;
            font-size: 13px;
            letter-spacing: 2px;
            z-index: 20;
        }

        .back-btn:hover {
            background: rgba(40, 28, 24, 0.9);
            box-shadow: 0 0 8px rgba(246, 231, 198, 0.7);
        }

        /* ===== ÈÅ†ÊôØÂ±±ËÑà ===== */
        .bg-mountain {
            position: absolute;
            bottom: -10vh;
            width: 50vw;
            height: 55vh;
            background: linear-gradient(to top, #a19c8d 0, #d5d0c3 60%, #f3f0e7 100%);
            border-radius: 60% 40% 0 0;
            opacity: 0.7;
            filter: blur(1px);
        }

        .bg-mountain.left {
            left: -10vw;
        }

        .bg-mountain.right {
            right: -15vw;
        }

        /* ===== Èõ≤Èúß ===== */
        .cloud {
            position: absolute;
            width: 220px;
            height: 60px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 40px;
            filter: blur(1px);
            opacity: 0.9;
            box-shadow:
                40px 8px 0 rgba(255, 255, 255, 0.9),
                90px -6px 0 rgba(255, 255, 255, 0.85);
            animation: drift 60s linear infinite;
        }

        .cloud.small {
            width: 160px;
            height: 45px;
            box-shadow:
                30px 6px 0 rgba(255, 255, 255, 0.9),
                70px -4px 0 rgba(255, 255, 255, 0.85);
        }

        .cloud.c1 {
            top: 14vh;
            left: -25vw;
            animation-delay: 0s;
        }

        .cloud.c2 {
            top: 28vh;
            left: -40vw;
            animation-delay: 8s;
        }

        .cloud.c3 {
            top: 8vh;
            left: -50vw;
            animation-delay: 18s;
        }

        .cloud.c4 {
            top: 36vh;
            left: -35vw;
            animation-delay: 28s;
        }

        @keyframes drift {
            from {
                transform: translateX(0);
            }

            to {
                transform: translateX(170vw);
            }
        }

        /* ===== Êá∏ÊµÆÂ≥∂ÂÖ±Áî®Ê®£Âºè ===== */
        .floating-island {
            position: absolute;
            width: 260px;
            height: 70px;
            background: linear-gradient(to bottom, #a2967a 0, #6c5f4a 60%, #4d4236 100%);
            border-radius: 60% 60% 50% 50%;
            box-shadow:
                0 10px 25px rgba(0, 0, 0, 0.4),
                0 -6px 10px rgba(255, 255, 255, 0.35) inset;
        }

        .floating-island::after {
            content: "";
            position: absolute;
            left: 15%;
            right: 15%;
            top: 30px;
            height: 80px;
            background: linear-gradient(to bottom, #756653 0, #4b4033 100%);
            clip-path: polygon(10% 0, 90% 0, 70% 40%, 60% 80%, 45% 100%, 30% 80%, 20% 40%);
            opacity: 0.95;
        }

        .island-left {
            bottom: 14vh;
            left: 6vw;
        }

        .island-mid {
            bottom: 18vh;
            left: 50%;
            transform: translateX(-50%);
        }

        .island-right {
            bottom: 12vh;
            right: 6vw;
        }

        /* ===== ÂÖ±Áî®ÔºöÂª∫ÁØâ‰∏äÊñπÂåæÈ°ç ===== */
        .building-sign {
            position: absolute;
            top: -90px;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 2px;
            border-radius: 16px;
            background: #2b1a16;
            border: 2px solid #f1d38f;
            color: #f6e7c6;
            font-size: 14px;
            letter-spacing: 4px;
            box-shadow:
                0 0 0 1px #674430 inset,
                0 4px 6px rgba(0, 0, 0, 0.5);
        }

        /* =========================
   Â∑¶ÂÅ¥ÔºöÂäüÊ≥ïÈñ£ÔºàËóèÊõ∏Ê®ìÔºâ
   ========================= */
        .temple-left-wrapper {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 170px;
            height: 160px;
        }

        /* Âè∞ÈöéËàáÊü±Â≠ê */
        .temple-base {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 130px;
            height: 30px;
            background: linear-gradient(to top, #b99c7a 0, #e2c8a3 70%);
            border-radius: 4px;
            box-shadow:
                0 0 0 2px #7e5f4b inset,
                0 7px 8px rgba(0, 0, 0, 0.4);
        }

        .temple-pillars {
            position: absolute;
            bottom: 18px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 58px;
            display: flex;
            justify-content: space-between;
            padding: 0 8px;
        }

        .temple-pillar {
            width: 10px;
            background: linear-gradient(to right, #6d3024 0, #8c3d2d 40%, #5a241a 100%);
            border-radius: 4px;
            box-shadow:
                0 0 0 1px #3a1510 inset,
                0 4px 6px rgba(0, 0, 0, 0.5);
        }

        /* ÈñÄÊ¥û */
        .temple-door {
            position: absolute;
            bottom: 18px;
            left: 50%;
            transform: translateX(-50%);
            width: 54px;
            height: 46px;
            background: #2b1c1a;
            border-radius: 2px 2px 0 0;
            box-shadow:
                0 0 0 2px #5d3c2f inset,
                0 2px 4px rgba(0, 0, 0, 0.7);
        }

        /* Â§öÂ±§Â±ãÈ†Ç */
        .temple-roof {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            height: 22px;
            background: linear-gradient(to bottom, #8d3f32 0, #4a1c18 100%);
            border-radius: 24px 24px 4px 4px;
            box-shadow:
                0 4px 0 #371412,
                0 8px 8px rgba(0, 0, 0, 0.4);
        }

        .temple-roof.r1 {
            bottom: 65px;
            width: 146px;
        }

        .temple-roof.r2 {
            bottom: 94px;
            width: 118px;
        }

        .temple-roof.r3 {
            bottom: 122px;
            width: 90px;
        }

        .temple-roof::before,
        .temple-roof::after {
            content: "";
            position: absolute;
            bottom: 4px;
            width: 22px;
            height: 18px;
            background: linear-gradient(to bottom, #a54a39 0, #4a1c18 100%);
            transform-origin: center bottom;
        }

        .temple-roof::before {
            left: -10px;
            transform: rotate(-16deg);
        }

        .temple-roof::after {
            right: -10px;
            transform: rotate(16deg);
        }

        /* È†ÇÁ´ØÂ∞èÂ°î */
        .temple-top-tower {
            position: absolute;
            bottom: 145px;
            left: 50%;
            transform: translateX(-50%);
            width: 32px;
            height: 40px;
            background: #c8b49b;
            border-radius: 4px 4px 0 0;
            box-shadow: 0 0 0 2px #7f664e inset;
        }

        .temple-top-tower::before {
            content: "";
            position: absolute;
            bottom: 30px;
            left: -10px;
            right: -10px;
            height: 18px;
            background: linear-gradient(to bottom, #8d3f32 0, #4a1c18 100%);
            border-radius: 18px 18px 4px 4px;
            box-shadow:
                0 3px 0 #371412,
                0 6px 6px rgba(0, 0, 0, 0.4);
        }

        .temple-top-tower::after {
            content: "";
            position: absolute;
            bottom: 52px;
            left: 50%;
            transform: translateX(-50%);
            width: 18px;
            height: 18px;
            background: #4a1c18;
            clip-path: polygon(50% 0, 100% 100%, 0 100%);
        }

        /* Êá∏ÊéõÁáàÁ±† */
        .lantern-row {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            width: 140px;
            display: flex;
            justify-content: space-around;
        }

        .lantern {
            width: 12px;
            height: 18px;
            background: radial-gradient(circle at 50% 20%, #fff6d2 0, #f89b3a 45%, #c34a1f 100%);
            border-radius: 50% 50% 40% 40%;
            box-shadow: 0 0 8px rgba(255, 180, 90, 0.7);
            position: relative;
        }

        .lantern::before {
            content: "";
            position: absolute;
            top: -6px;
            left: 50%;
            width: 2px;
            height: 6px;
            background: #4a1c18;
            transform: translateX(-50%);
        }

        .lantern::after {
            content: "";
            position: absolute;
            bottom: -4px;
            left: 50%;
            width: 6px;
            height: 4px;
            background: #c34a1f;
            transform: translateX(-50%);
        }

        /* =========================
   ‰∏≠Â§ÆÔºöÊ¶ÆË≠ΩÂ†ÇÔºàÂÆóÈñÄÂ§ßÈñÄÔºâ
   ========================= */
        .gate {
            position: absolute;
            bottom: 38px;
            left: 50%;
            transform: translateX(-50%);
            width: 220px;
            height: 160px;
            cursor: pointer;
            /* Âä†ÂÄãÊâãÂΩ¢ */
        }

        /* ÂåæÈ°çÔºöÊ¶ÆË≠ΩÂ†Ç */
        .gate .building-sign {
            top: -55px;
        }

        /* Áü≥Âè∞Èöé */
        .gate-base {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 160px;
            height: 26px;
            background: linear-gradient(to top, #b4a48e 0, #e2d8c4 70%);
            border-radius: 3px;
            box-shadow:
                0 0 0 2px #8a7a65 inset,
                0 7px 8px rgba(0, 0, 0, 0.45);
        }

        /* ÂÖ©ÂÅ¥Â§ßÊü± */
        .gate-column {
            position: absolute;
            bottom: 24px;
            width: 40px;
            height: 110px;
            background: linear-gradient(to right, #864632 0, #b56a4a 40%, #6f3628 100%);
            box-shadow:
                0 0 0 2px #4b1e18 inset,
                0 6px 10px rgba(0, 0, 0, 0.55);
            border-radius: 4px;
        }

        .gate-column.left {
            left: 22px;
        }

        .gate-column.right {
            right: 22px;
        }

        .gate-column::before {
            content: "";
            position: absolute;
            inset: 14px 7px;
            border-radius: 4px;
            border: 1px solid rgba(250, 214, 142, 0.7);
            opacity: 0.9;
        }

        .gate-column::after {
            content: "";
            position: absolute;
            bottom: -26px;
            left: 50%;
            transform: translateX(-50%);
            width: 26px;
            height: 32px;
            background: #6d3a2d;
            clip-path: polygon(0 0, 100% 0, 50% 100%);
            box-shadow:
                0 0 0 1px #3a1714 inset,
                0 6px 8px rgba(0, 0, 0, 0.6);
        }

        /* ÂÅ¥ÁøºÈ£õÊ™ê */
        .gate-wing {
            position: absolute;
            bottom: 98px;
            width: 86px;
            height: 20px;
            background: linear-gradient(to bottom, #8d3f32 0, #4a1c18 100%);
            border-radius: 20px 20px 4px 4px;
            box-shadow:
                0 3px 0 #371412,
                0 7px 6px rgba(0, 0, 0, 0.45);
        }

        .gate-wing.left {
            left: -4px;
        }

        .gate-wing.right {
            right: -4px;
        }

        .gate-wing::before,
        .gate-wing::after {
            content: "";
            position: absolute;
            bottom: 3px;
            width: 20px;
            height: 16px;
            background: linear-gradient(to bottom, #a54a39 0, #4a1c18 100%);
            transform-origin: center bottom;
        }

        .gate-wing::before {
            left: -10px;
            transform: rotate(-16deg);
        }

        .gate-wing::after {
            right: -10px;
            transform: rotate(16deg);
        }

        /* ‰∏≠Â§ÆÊ©´Ê®ë */
        .gate-top {
            position: absolute;
            bottom: 104px;
            left: 28px;
            right: 28px;
            height: 26px;
            background: linear-gradient(to bottom, #7c4033 0, #4b221f 100%);
            box-shadow:
                0 4px 0 #321312,
                0 8px 8px rgba(0, 0, 0, 0.4);
        }

        /* ‰∏äÊñπÊã±ÂΩ¢Â±ãÈ†Ç */
        .gate-crest {
            position: absolute;
            bottom: 132px;
            left: 50%;
            transform: translateX(-50%);
            width: 130px;
            height: 40px;
            background: #7c4033;
            border-radius: 60px 60px 12px 12px;
            box-shadow:
                0 4px 0 #4b221f,
                0 12px 10px rgba(0, 0, 0, 0.45);
        }

        .gate-crest::before,
        .gate-crest::after {
            content: "";
            position: absolute;
            bottom: 6px;
            width: 30px;
            height: 20px;
            background: linear-gradient(to bottom, #a54a39 0, #4a1c18 100%);
            transform-origin: center bottom;
        }

        .gate-crest::before {
            left: -16px;
            transform: rotate(-18deg);
        }

        .gate-crest::after {
            right: -16px;
            transform: rotate(18deg);
        }

        /* ÈáëËâ≤ÂÖßÊ°Ü */
        .gate-crest-inner {
            position: absolute;
            bottom: 138px;
            left: 50%;
            transform: translateX(-50%);
            width: 110px;
            height: 28px;
            border-radius: 30px;
            border: 2px solid #f4d79e;
        }

        /* ‰∏≠Â§ÆÊá∏ÊµÆÂÖâÁí∞ */
        .gate-ring {
            position: absolute;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: 3px solid rgba(255, 200, 120, 0.9);
            box-shadow:
                0 0 9px rgba(255, 210, 140, 0.9),
                0 0 18px rgba(255, 210, 140, 0.7);
        }

        /* =========================
   Âè≥ÂÅ¥Ôºö‰ªôÈùàÊ±†
   ========================= */
        .spirit-pool-wrapper {
            position: absolute;
            bottom: 26px;
            left: 50%;
            transform: translateX(-50%);
            width: 180px;
            height: 130px;
        }

        /* Áü≥Âü∫Â∫ß */
        .pool-base {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 140px;
            height: 26px;
            background: linear-gradient(to top, #bca88d 0, #e6d5bd 70%);
            border-radius: 10px;
            box-shadow:
                0 0 0 2px #7a644e inset,
                0 6px 8px rgba(0, 0, 0, 0.45);
        }

        /* ÈùàÊ±†Â§ñÂúà */
        .pool-ring {
            position: absolute;
            bottom: 18px;
            left: 50%;
            transform: translateX(-50%);
            width: 130px;
            height: 50px;
            background: radial-gradient(circle at 50% 40%, #f7f4ee 0, #c5b8a2 80%);
            border-radius: 50%;
            box-shadow:
                0 0 0 2px #9a8871 inset,
                0 3px 6px rgba(0, 0, 0, 0.4);
        }

        /* ÈùàÊ±†Ê∞¥Èù¢ */
        .pool-water {
            position: absolute;
            bottom: 26px;
            left: 50%;
            transform: translateX(-50%);
            width: 114px;
            height: 34px;
            background: radial-gradient(circle at 50% 20%, #b9f7ff 0, #67c3d6 45%, #3a7f95 90%);
            border-radius: 50%;
            box-shadow:
                0 0 10px rgba(120, 220, 240, 0.8),
                0 0 18px rgba(110, 200, 230, 0.6);
        }

        /* ÈùàÂäõÊóãÊ∏¶ */
        .pool-ripple {
            position: absolute;
            inset: 6px 14px;
            border-radius: 50%;
            border: 1px dashed rgba(255, 255, 255, 0.7);
            opacity: 0.7;
            animation: rippleSpin 10s linear infinite;
        }

        @keyframes rippleSpin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* ‰∏≠Â§ÆÈùàÊü± */
        .spirit-pillar {
            position: absolute;
            bottom: 52px;
            left: 50%;
            transform: translateX(-50%);
            width: 26px;
            height: 70px;
            background: linear-gradient(to top, #f2f1ef 0, #ffffff 40%);
            border-radius: 20px;
            box-shadow:
                0 0 0 2px #d6cec4 inset,
                0 0 16px rgba(165, 240, 255, 0.9);
        }

        /* ÈùàÊü±È†ÇÁ´ØÂÖâÁí∞ */
        .spirit-ring {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid rgba(192, 248, 255, 0.9);
            box-shadow:
                0 0 8px rgba(180, 245, 255, 0.9),
                0 0 18px rgba(180, 245, 255, 0.7);
        }

        /* ÈùàÁÅ´ */
        .spirit-flame {
            position: absolute;
            top: -22px;
            left: 50%;
            transform: translateX(-50%);
            width: 18px;
            height: 26px;
            background: radial-gradient(circle at 50% 20%, #ffffff 0, #fffac5 30%, #8ef1ff 60%, #2da0ff 90%);
            clip-path: polygon(50% 0, 100% 40%, 70% 100%, 30% 100%, 0 40%);
            box-shadow: 0 0 16px rgba(160, 240, 255, 0.9);
        }

        /* =========================
           Êñ∞Â¢ûÔºöËóèÂØ∂Èñ£ÔºàÂïÜÂ∫óÔºâ
           ========================= */
        .island-shop {
            bottom: 22vh;
            left: 72%;
            transform: translateX(-50%);
            z-index: 5;
        }

        .shop-wrapper {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 160px;
            height: 140px;
            cursor: pointer;
        }

        .shop-base {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 24px;
            background: #5d4037;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
        }

        .shop-body {
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 80px;
            background: #795548;
            border: 2px solid #3e2723;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* ÈáëËâ≤Â±ãÈ†Ç */
        .shop-roof {
            position: absolute;
            bottom: 104px;
            left: 50%;
            transform: translateX(-50%);
            width: 140px;
            height: 30px;
            background: linear-gradient(to bottom, #ffecb3 0%, #ffca28 100%);
            border-radius: 40px 40px 4px 4px;
            box-shadow: 0 4px 0 #ff6f00, 0 8px 8px rgba(0, 0, 0, 0.4);
        }

        .shop-roof::before {
            content: "";
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 20px;
            background: #ffca28;
            border-radius: 50%;
            border: 2px solid #ff6f00;
        }

        /* ÈñÄÁ∞æÂ§ßÂ§ßÁöÑ "ÂØ∂" Â≠ó */
        .shop-sign-text {
            color: #ffca28;
            font-size: 24px;
            font-weight: bold;
            border: 2px solid #ffca28;
            padding: 4px;
            border-radius: 4px;
            background: #3e2723;
        }

        /* ===== LOGO ===== */
        .logo {
            position: absolute;
            top: 20px;
            right: 40px;
            font-size: 28px;
            letter-spacing: 4px;
            color: #3c2c22;
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }

        .logo span.red {
            color: #b23118;
            font-size: 18px;
            border: 1px solid #b23118;
            padding: 2px 3px;
            margin-bottom: 4px;
        }

        /* ‰∏≠ÊôØÂ±±ÔºàÂú®‰∏≠ÈñìÂÅèÂ∑¶Âè≥Ôºâ */
        .bg-mountain.mid {
            width: 35vw;
            height: 45vh;
            opacity: 0.8;
        }

        /* Â∞è‰∏ÄÈªûÁöÑÂ±±Â≥∞ */
        .bg-mountain.small-peak {
            width: 22vw;
            height: 38vh;
            opacity: 0.9;
            filter: blur(0.5px);
        }

        /* ====== Êñ∞Â¢ûÔºöÊï¥ÊéíÂ±±ËÑà ====== */

        /* ÈÅ†Â±±ÔºàÊúÄÊ∑°„ÄÅÊúÄÂ§ßÔºâ */
        .mountain-range-back {
            position: absolute;
            bottom: -5vh;
            left: 0;
            width: 200vw;
            height: 40vh;
            background: radial-gradient(circle at 50% 120%, #e1ddd3 0%, #c9c3b8 70%, transparent 100%);
            opacity: 0.55;
            transform: translateX(-20vw);
            filter: blur(2px);
            z-index: 0;
        }

        /* ‰∏≠ÊôØÂ±±ÔºàËºÉÊ∑±„ÄÅÊúâËµ∑‰ºèÔºâ */
        .mountain-range-mid {
            position: absolute;
            bottom: -6vh;
            left: 0;
            width: 200vw;
            height: 32vh;
            background: #b8ae9e;
            clip-path: polygon(0% 60%, 10% 45%, 25% 55%, 35% 38%, 50% 52%,
                    65% 40%, 75% 60%, 90% 42%, 100% 55%, 100% 100%, 0% 100%);
            opacity: 0.75;
            z-index: 1;
        }

        /* ËøëÊôØÂ±±ÔºàÊ∑±Ëâ≤„ÄÅ‰ΩéÈ´òÂ∫¶Ôºâ */
        .mountain-range-front {
            position: absolute;
            bottom: -4vh;
            left: 0;
            width: 200vw;
            height: 20vh;
            background: #8a7f6f;
        }

        /* ===== Ê∞¥Â¢®Â±±ËÑàÔºö‰∏âÂ±§Â±± + Èúß ===== */

        /* ÈÅ†ËôïÊ∑°ËóçÂ±±ËÑà */
        .ink-mountain-back {
            position: absolute;
            bottom: -10vh;
            left: -10vw;
            width: 140vw;
            height: 55vh;
            background: #c7d9e7;
            clip-path: polygon(0% 80%, 5% 65%, 12% 70%, 18% 55%, 25% 60%,
                    33% 50%, 42% 58%, 50% 40%, 60% 55%, 70% 48%,
                    78% 60%, 88% 52%, 95% 65%, 100% 60%,
                    100% 100%, 0% 100%);
            opacity: 0.55;
            filter: blur(1.5px);
        }

        /* ‰∏≠ÊôØÁÅ∞Â±±ËÑà */
        .ink-mountain-mid {
            position: absolute;
            bottom: -8vh;
            left: -10vw;
            width: 140vw;
            height: 45vh;
            background: #b8c0c7;
            clip-path: polygon(0% 85%, 6% 70%, 15% 75%, 24% 62%, 32% 68%,
                    41% 58%, 52% 64%, 61% 55%, 72% 63%, 82% 57%,
                    92% 68%, 100% 62%, 100% 100%, 0% 100%);
            opacity: 0.7;
            filter: blur(1px);
        }

        /* ÂâçÊôØÊ∑±Â±±Ââ™ÂΩ± */
        .ink-mountain-front {
            position: absolute;
            bottom: -6vh;
            left: -10vw;
            width: 140vw;
            height: 35vh;
            background: #9f968a;
            clip-path: polygon(0% 90%, 8% 78%, 18% 82%, 28% 72%, 40% 78%,
                    52% 70%, 64% 80%, 76% 72%, 88% 82%, 100% 76%,
                    100% 100%, 0% 100%);
            opacity: 0.9;
        }

        /* Â±±ËÖ∞ÁôΩÈúß */
        .ink-mountain-fog {
            position: absolute;
            bottom: 10vh;
            left: -10vw;
            width: 140vw;
            height: 20vh;
            background:
                radial-gradient(circle at 15% 100%, rgba(255, 255, 255, 0.9), transparent 60%),
                radial-gradient(circle at 45% 110%, rgba(255, 255, 255, 0.9), transparent 60%),
                radial-gradient(circle at 80% 95%, rgba(255, 255, 255, 0.9), transparent 60%);
            opacity: 0.85;
            filter: blur(4px);
        }

        /* ===============================
   Âª∫ÁØâ Hover ÊîæÂ§ß + ‰∏äÂçá ÊïàÊûú
   =============================== */
        .temple-left-wrapper,
        .gate,
        .spirit-pool-wrapper,
        .shop-wrapper {
            transition: transform 0.28s ease-out, filter 0.28s ease-out;
            transform-origin: center bottom;
        }

        /* ÊªëÈº†Áßª‰∏äÂéªÔºöÂæÆÂæÆÊîæÂ§ß + ‰∏äÂçá */
        .temple-left-wrapper:hover,
        .gate:hover,
        .spirit-pool-wrapper:hover,
        .shop-wrapper:hover {
            transform: translateX(-50%) scale(1.04);
            filter: brightness(1.08);
        }

        /* ÂåæÈ°ç‰∫Æ‰∏ÄÈªû */
        .temple-left-wrapper:hover .building-sign,
        .gate:hover .building-sign,
        .spirit-pool-wrapper:hover .building-sign,
        .shop-wrapper:hover .building-sign {
            filter: brightness(1.18);
        }
    </style>
</head>

<body>
    <div class="scene">

        <div class="mountain-range-back"></div>
        <div class="mountain-range-mid"></div>
        <div class="mountain-range-front"></div>

        <!-- ÈÅ†ÊñπÂ±±ËÑà -->
        <div class="bg-mountain left"></div>
        <div class="bg-mountain right"></div>

        <div class="ink-mountain-back"></div>
        <div class="ink-mountain-mid"></div>
        <div class="ink-mountain-front"></div>
        <div class="ink-mountain-fog"></div>

        <!-- È£ÑÂãïÈõ≤Èúß -->
        <div class="cloud c1"></div>
        <div class="cloud small c2"></div>
        <div class="cloud small c3"></div>
        <div class="cloud c4"></div>

        <!-- ‰∏≠ÊôØÂ±± -->
        <div class="bg-mountain mid" style="left:18vw; bottom:-8vh;"></div>
        <div class="bg-mountain mid" style="right:20vw; bottom:-6vh;"></div>

        <!-- Â∞èÂ±±Â≥∞ -->
        <div class="bg-mountain small-peak" style="left:35vw; bottom:-4vh;"></div>
        <div class="bg-mountain small-peak" style="right:34vw; bottom:-5vh;"></div>

        <!-- Â∑¶ÂÅ¥Êá∏ÊµÆÂ≥∂ÔºöÂäüÊ≥ïÈñ£ -->
        <div class="floating-island island-left">
            <div class="temple-left-wrapper" onclick="goBook()">
                <div class="building-sign">ÂäüÊ≥ïÈñ£</div>
                <div class="temple-base"></div>
                <div class="temple-pillars">
                    <div class="temple-pillar"></div>
                    <div class="temple-pillar"></div>
                    <div class="temple-pillar"></div>
                    <div class="temple-pillar"></div>
                </div>
                <div class="temple-door"></div>
                <div class="temple-roof r1"></div>
                <div class="temple-roof r2"></div>
                <div class="temple-roof r3"></div>
                <div class="lantern-row">
                    <div class="lantern"></div>
                    <div class="lantern"></div>
                    <div class="lantern"></div>
                </div>
                <div class="temple-top-tower"></div>
            </div>
        </div>

        <!-- ‰∏≠Â§ÆÊá∏ÊµÆÂ≥∂ÔºöÊ¶ÆË≠ΩÂ†Ç -->
        <div class="floating-island island-mid">
            <!-- ‚≠ê ÈÄôË£°Âä† onclick="goHonor()" ‚≠ê -->
            <div class="gate" onclick="goHonor()">
                <div class="building-sign">Ê¶ÆË≠ΩÂ†Ç</div>
                <div class="gate-base"></div>
                <div class="gate-column left"></div>
                <div class="gate-column right"></div>
                <div class="gate-top"></div>
                <div class="gate-wing left"></div>
                <div class="gate-wing right"></div>
                <div class="gate-crest"></div>
                <div class="gate-crest-inner"></div>
                <div class="gate-ring"></div>
            </div>
        </div>

        <!-- Âè≥ÂÅ¥Êá∏ÊµÆÂ≥∂Ôºö‰ªôÈùàÊ±† -->
        <div class="floating-island island-right">
            <div class="spirit-pool-wrapper" onclick="goPool()">
                <div class="building-sign">‰ªôÈùàÊ±†</div>
                <div class="pool-base"></div>
                <div class="pool-ring"></div>
                <div class="pool-water">
                    <div class="pool-ripple"></div>
                </div>
                <div class="spirit-pillar">
                    <div class="spirit-ring"></div>
                    <div class="spirit-flame"></div>
                </div>
            </div>
        </div>

        <!-- Âè≥‰∏≠ÔºöËóèÂØ∂Èñ£ -->
        <div class="floating-island island-shop">
            <div class="shop-wrapper" onclick="openShop()">
                <div class="building-sign">ËóèÂØ∂Èñ£</div>
                <div class="shop-roof"></div>
                <div class="shop-body">
                    <div class="shop-sign-text"
                        style="color:#ffca28; font-weight:bold; font-size:24px; background:#3e2723; padding:4px; border:1px solid #ffca28;">
                        ÂØ∂</div>
                </div>
                <div class="shop-base"></div>
            </div>
        </div>

        <!-- Â∑¶‰∏≠ÔºöË≤¢ÁçªÂ†Ç (Êñ∞Â¢û) -->
        <div class="floating-island island-left"
            style="bottom: 22vh; left: 28%; transform: translateX(-50%); z-index: 5;">
            <div class="shop-wrapper" onclick="openContribHall()">
                <div class="building-sign">Ë≤¢ÁçªÂ†Ç</div>
                <!-- Â±ãÈ†ÇÊèõÂÄãÈ°èËâ≤ (ÈùíËâ≤/ÁÅ∞Ëâ≤) -->
                <div class="shop-roof"
                    style="background: linear-gradient(to bottom, #cfd8dc 0%, #90a4ae 100%); box-shadow: 0 4px 0 #546e7a, 0 8px 8px rgba(0,0,0,0.4);">
                </div>
                <div class="shop-body" style="background: #5d4037; border-color: #3e2723;">
                    <div class="shop-sign-text"
                        style="color:#eceff1; font-weight:bold; font-size:24px; background:#455a64; padding:4px; border:1px solid #cfd8dc;">
                        Ë≥û</div>
                </div>
                <div class="shop-base"></div>
            </div>
        </div>

        <!-- Âè≥‰∏äËßí LOGO È¢®Ê†ºÂ≠óÊ®£ -->
        <div class="logo">
            <span class="red">‰øÆ</span>
            ‰ªôÂÆóÈñÄ
            <div id="faction-info-panel" style="
                writing-mode: horizontal-tb; 
                direction: ltr;
                font-size: 14px; 
                margin-top: 10px; 
                color: #5d4037;
                background: rgba(255, 255, 255, 0.6);
                padding: 8px 12px;
                border-radius: 6px;
                border: 1px solid #d7ccc8;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                display: flex;
                flex-direction: column;
                gap: 4px;
                align-items: flex-start;
                min-width: 120px;
            ">
                <div
                    style="font-weight: bold; color: #3e2723; border-bottom: 1px solid #a1887f; padding-bottom: 2px; width: 100%;">
                    <span id="f-name">ÁÑ°ÈñÄÁÑ°Ê¥æ</span>
                </div>
                <div>‰ΩçÈöéÔºö<span id="f-rank">ÁÑ°</span></div>
                <div>‰ΩçÈöéÔºö<span id="f-rank">ÁÑ°</span></div>
                <div>Ë≤¢ÁçªÔºö<span id="f-contrib" style="color: #d84315; font-weight: bold;">0</span></div>
                <div>ÈùàÁü≥Ôºö<span id="f-stones" style="color: #1976d2; font-weight: bold;">0</span></div>
            </div>
        </div>
    </div>
    <!-- ÂïÜÂ∫óÊ®°ÊÖãÊ°Ü -->
    <div id="shop-modal" class="modal-overlay"
        style="display: none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:100; justify-content:center; align-items:center;">
        <div class="modal-content"
            style="width: 500px; max-width:90%; background:#fff3e0; padding:20px; border-radius:8px; border:2px solid #5d4037; position:relative;">
            <h2 style="text-align: center; color: #5d4037; margin-bottom: 20px;">ÂÆóÈñÄËóèÂØ∂Èñ£</h2>
            <div style="text-align: right; margin-bottom: 10px; color: #5d4037; font-weight: bold;">
                Áï∂ÂâçË≤¢ÁçªÔºö<span id="shop-contrib-display">0</span>
            </div>

            <div id="shop-items-container"
                style="max-height: 400px; overflow-y: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <!-- ÂïÜÂìÅÂàóË°® -->
            </div>

            <button onclick="closeModal('shop-modal')"
                style="margin-top: 20px; width: 100%; padding: 10px; background: #8d6e63; color: white; border: none; border-radius: 4px; cursor: pointer;">Èõ¢Èñã</button>
        </div>
    </div>
    <!-- Ë≤¢ÁçªÂ†ÇÊ®°ÊÖãÊ°Ü -->
    <div id="contrib-modal" class="modal-overlay"
        style="display: none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:100; justify-content:center; align-items:center;">
        <div class="modal-content"
            style="width: 600px; max-width:90%; background:#eceff1; padding:20px; border-radius:8px; border:2px solid #37474f; position:relative; overflow:hidden;">
            <h2 style="text-align: center; color: #37474f; margin-bottom: 20px;">ÂÆóÈñÄË≤¢ÁçªÂ†Ç</h2>

            <div class="tabs" style="display:flex; justify-content:center; gap:10px; margin-bottom:15px;">
                <button onclick="switchContribTab('bounty')" id="tab-bounty"
                    style="padding:8px 16px; cursor:pointer; background:#546e7a; color:white; border:none; border-radius:4px;">Êá∏Ë≥û‰ªªÂãô</button>
                <button onclick="switchContribTab('minigame')" id="tab-minigame"
                    style="padding:8px 16px; cursor:pointer; background:#90a4ae; color:white; border:none; border-radius:4px;">‰ºëÈñíÂ®õÊ®Ç</button>
            </div>

            <!-- Êá∏Ë≥ûÂçÄÂüü -->
            <div id="contrib-section-bounty" style="max-height: 400px; overflow-y: auto;">
                <div id="bounty-list" style="display:grid; gap:10px;"></div>
            </div>

            <!-- Â∞èÈÅäÊà≤ÂçÄÂüü -->
            <div id="contrib-section-minigame" style="display:none; text-align:center;">
                <h3>ÂÆóÈñÄÂ∞èÈÅäÊà≤</h3>
                <p>ËºïÈ¨Ü‰∏Ä‰∏ãÔºåË≥∫ÂèñÂæÆËñÑÁöÑË≤¢ÁçªÊàñÈùàÁü≥„ÄÇ</p>

                <div style="margin-top:20px; display:flex; flex-direction:column; gap:15px;">
                    <!-- ÁåúÂ§ßÂ∞è -->
                    <div style="background:#fff; padding:10px; border-radius:4px; border:1px solid #cfd8dc;">
                        <h4>üé≤ ÈùàÁü≥Ë≥≠Âùä (ÁåúÂ§ßÂ∞è)</h4>
                        <div style="margin-bottom:8px; font-size:12px; color:#666;">
                            ‰∏ãÊ≥®ÈùàÁü≥Ôºö
                            <input type="number" id="gamble-bet" value="10" min="10" style="width:60px; padding:2px;"
                                oninput="validateGambleBet()">
                            <span id="gamble-error"
                                style="color:red; font-size:12px; display:none; margin-left:5px;">‰∏çË∂≥</span>
                            (Ë¥è‰∫ÜÁøªÂÄç)
                        </div>
                        <div style="margin-top:10px;">
                            <button onclick="playGamble('low')"
                                style="padding:5px 15px; background:#e57373; color:white; border:none; border-radius:4px; margin-right:5px;">ÊäºÂ∞è
                                (1-3)</button>
                            <button onclick="playGamble('high')"
                                style="padding:5px 15px; background:#64b5f6; color:white; border:none; border-radius:4px;">ÊäºÂ§ß
                                (4-6)</button>
                        </div>
                        <div id="gamble-result" style="margin-top:5px; font-weight:bold; height:20px;"></div>
                    </div>

                    <!-- ÁåúÊã≥ -->
                    <div style="background:#fff; padding:10px; border-radius:4px; border:1px solid #cfd8dc;">
                        <h4>‚úåÔ∏è ËàáÈï∑ËÄÅÁåúÊã≥</h4>
                        <div style="margin-bottom:8px; font-size:12px; color:#666;">
                            ‰∏ãÊ≥®Ë≤¢ÁçªÔºö
                            <input type="number" id="rps-bet" value="10" min="10" style="width:60px; padding:2px;"
                                oninput="validateRPSBet()">
                            <span id="rps-error"
                                style="color:red; font-size:12px; display:none; margin-left:5px;">‰∏çË∂≥</span>
                            (Ë¥è‰∫ÜÁøªÂÄç)
                        </div>
                        <div style="margin-top:10px;">
                            <button onclick="playRPS(0)"
                                style="font-size:20px; padding:5px 15px; cursor:pointer;">‚úÇÔ∏è</button>
                            <button onclick="playRPS(1)"
                                style="font-size:20px; padding:5px 15px; cursor:pointer;">‚úä</button>
                            <button onclick="playRPS(2)"
                                style="font-size:20px; padding:5px 15px; cursor:pointer;">üñêÔ∏è</button>
                        </div>
                        <div id="rps-result" style="margin-top:5px; font-weight:bold; height:20px;"></div>
                    </div>
                </div>
            </div>

            <button onclick="closeModal('contrib-modal')"
                style="margin-top: 20px; width: 100%; padding: 10px; background: #37474f; color: white; border: none; border-radius: 4px; cursor: pointer;">Èõ¢Èñã</button>
        </div>
    </div>
</body>
<!-- 3. Load Contribution Logic -->
<script src="contribution.js"></script>
<script>
    // ÂïÜÂìÅÂàóË°®ÂÆöÁæ© (Sect Shop items)
    const SectShopList = [
        // === ÂõõËóùÂÖ∏Á±ç (È´òÂÉπ) ===
        { id: "alchemy_manual", price: 5000, desc: "ÁøíÂæóÁÖâ‰∏πË°ì" },
        { id: "weapon_manual", price: 5000, desc: "ÁøíÂæóÁÖâÂô®Ë°ì" },
        { id: "formation_manual", price: 5000, desc: "ÁøíÂæóÈô£Ê≥ïË°ì" },
        { id: "talisman_manual", price: 5000, desc: "ÁøíÂæóÁ¨¶Á±ôË°ì" },

        // === Âü∫Á§éÁî¢Áâ© ===
        { id: "qi_pill_fixed_large", price: 50, desc: "ÂõûÂæ©500ÁúüÊ∞£" },
        { id: "mind_pill", price: 100, desc: "ÂøÉÂ¢É+1" },
        { id: "comp_tea", price: 150, desc: "ÊÇüÊÄß+1" },
        { id: "luck_charm", price: 200, desc: "Ê∞£ÈÅã+1" },

        // === ÈÄ≤ÈöéÁî¢Áâ© ===
        { id: "attack_pill_small", price: 300, desc: "ÊîªÊìä+2" },
        { id: "defense_pill_small", price: 300, desc: "Èò≤Á¶¶+2" },

        // === ÂõõËóùÁõ∏ÈóúÊùêÊñô ===
        { id: "spirit_stone_small", price: 20, desc: "‰∏ãÂìÅÈùàÁü≥" }
    ];

    function openShop() {
        const modal = document.getElementById('shop-modal');
        const container = document.getElementById('shop-items-container');
        const contribDisplay = document.getElementById('shop-contrib-display');

        if (!modal || !container) return;

        // Access parent state safely
        const state = (window.parent && window.parent.gameState) || window.gameState;
        const contrib = state ? (state.factionContrib || 0) : 0;

        if (contribDisplay) contribDisplay.textContent = contrib;

        container.innerHTML = '';

        SectShopList.forEach(itemConfig => {
            const parentDB = window.parent.ItemDB;
            const itemDef = parentDB ? parentDB[itemConfig.id] : null;

            const name = itemDef ? itemDef.name : itemConfig.id;
            // Simple color fallback
            let color = '#333';
            if (itemDef) {
                switch (itemDef.rarity) {
                    case 'purple': color = '#9c27b0'; break;
                    case 'blue': color = '#2196f3'; break;
                    case 'green': color = '#4caf50'; break;
                    case 'orange': color = '#ff9800'; break;
                }
            }

            const div = document.createElement('div');
            div.style.border = '1px solid #d7ccc8';
            div.style.padding = '10px';
            div.style.borderRadius = '4px';
            div.style.background = '#efebe9';
            div.style.display = 'flex';
            div.style.flexDirection = 'column';
            div.style.justifyContent = 'space-between';

            div.innerHTML = `
                <div style="font-weight: bold; color: ${color}; margin-bottom: 4px;">${name}</div>
                <div style="font-size: 12px; color: #5d4037; margin-bottom: 8px;">${itemConfig.desc}</div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #d84315; font-weight: bold; font-size: 12px;">${itemConfig.price} Ë≤¢Áçª</span>
                    <button onclick="buySectItem('${itemConfig.id}', ${itemConfig.price})" 
                        style="padding: 4px 8px; background: #795548; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        ÂÖåÊèõ
                    </button>
                </div>
            `;
            container.appendChild(div);
        });

        modal.style.display = 'flex';
    }

    function buySectItem(itemId, price) {
        const state = (window.parent && window.parent.state) || window.state;
        if (!state) return;

        if ((state.factionContrib || 0) < price) {
            alert("ÂÆóÈñÄË≤¢Áçª‰∏çË∂≥ÔºÅ");
            return;
        }

        // Êâ£Èô§Ë≤¢Áçª
        state.factionContrib -= price;

        // Ê∑ªÂä†Áâ©ÂìÅ
        if (window.parent && window.parent.addItem) {
            window.parent.addItem(itemId, 1);
        } else {
            console.error("Cannot find addItem function in parent window");
            alert("Ë≥ºË≤∑Â§±ÊïóÔºöÁ≥ªÁµ±ÈåØË™§");
            return;
        }

        alert(`ÂÖåÊèõÊàêÂäüÔºÅ`);
        openShop(); // Âà∑Êñ∞È°ØÁ§∫

        // ÂêåÊ≠•UI
        if (window.parent.renderUI) window.parent.renderUI();
        updateFactionUI(); // Update local display
    }

    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }

    // ===== Ë≤¢ÁçªÂ†ÇÈÇèËºØ =====
    function openContribHall() {
        const modal = document.getElementById('contrib-modal');
        if (modal) modal.style.display = 'flex';

        // Âº∑Âà∂ÂàáÊèõÂà∞Êá∏Ë≥ûÂàÜÈ†Å
        switchContribTab('bounty');

        if (!window.ContributionHall) {
            console.error("ContributionHall module missing!");
            alert("Á≥ªÁµ±ÈåØË™§ÔºöÊá∏Ë≥ûÊ®°ÁµÑÊú™ËºâÂÖ•ÔºåË´ãÂà∑Êñ∞È†ÅÈù¢ÈáçË©¶„ÄÇ");
            return;
        }
        renderBountyList();
    }

    function switchContribTab(tab) {
        document.getElementById('contrib-section-bounty').style.display = (tab === 'bounty') ? 'block' : 'none';
        document.getElementById('contrib-section-minigame').style.display = (tab === 'minigame') ? 'block' : 'none';

        document.getElementById('tab-bounty').style.background = (tab === 'bounty') ? '#546e7a' : '#90a4ae';
        document.getElementById('tab-minigame').style.background = (tab === 'minigame') ? '#546e7a' : '#90a4ae';
    }

    function renderBountyList() {
        // Access state properly to check completion
        const pWin = window.parent || window;
        const state = pWin.gameState || pWin.state || window.state;

        const container = document.getElementById('bounty-list');
        if (!container || !window.ContributionHall) return;

        container.innerHTML = '';
        window.ContributionHall.bosses.forEach(boss => {
            const div = document.createElement('div');
            div.style.background = '#fff';
            div.style.padding = '10px';
            div.style.border = '1px solid #cfd8dc';
            div.style.borderRadius = '4px';
            div.style.display = 'flex';
            div.style.justifyContent = 'space-between';
            div.style.alignItems = 'center';

            // Calculate Approximate Real CP based on stats formula
            // New formula based on nerfed stats (HP*12, Atk*1, Def*0.2)
            // Approx weight: 12*0.8 + 1*5 + 0.2*3 = 9.6 + 5 + 0.6 = ~15.2
            // Base CP = Power * 15 + Crit/Luck offset (~50)
            const realCP = Math.floor(boss.power * 15 + 50);

            const isCompleted = state && state.completedChallenges && state.completedChallenges.includes(boss.id);
            const btnHtml = isCompleted
                ? `<button disabled style="padding:6px 12px; background:#78909c; color:#eceff1; border:none; border-radius:4px; cursor:not-allowed;">Â∑≤ÂÆåÊàê</button>`
                : `<button onclick="ContributionHall.challengeBoss('${boss.id}')" style="padding:6px 12px; background:#bf360c; color:white; border:none; border-radius:4px; cursor:pointer;">ÊåëÊà∞</button>`;

            div.innerHTML = `
                <div>
                    <div style="font-weight:bold; color:${isCompleted ? '#78909c' : '#d84315'};">${boss.name}</div>
                    <div style="font-size:12px; color:#546e7a;">${boss.desc}</div>
                    <div style="font-size:12px; margin-top:4px;">
                        <span>Êà∞Âäõ: ${realCP}</span> | 
                        <span style="color:${isCompleted ? '#90a4ae' : '#2e7d32'};">ÁçéÂãµ: ${boss.rewardStones} ÈùàÁü≥, ${boss.rewardContrib} Ë≤¢Áçª, ${boss.rewardRep} ËÅ≤Êúõ</span>
                    </div>
                </div>
                ${btnHtml}
            `;
            container.appendChild(div);
        });
    }

    // DEBUG WRAPPER
    function debugChallenge(bossId) {
        alert("Debug: Button Clicked! Boss ID: " + bossId);
        if (window.ContributionHall) {
            window.ContributionHall.challengeBoss(bossId);
        } else {
            alert("Error: ContributionHall object not found!");
        }
    }

    // === Êà∞È¨•ËøîÂõûËôïÁêÜ (Battle Return Handler) ===
    (function checkBattleReturn() {
        // Wait for DOM and Scripts
        setTimeout(() => {
            const battleReturn = localStorage.getItem("battle-return-to");
            if (battleReturn === "contribution") {
                console.log("Returning from contribution battle...");

                const resultRaw = localStorage.getItem("battle-result");
                if (resultRaw) {
                    try {
                        const result = JSON.parse(resultRaw);
                        const bossId = result.bossId;

                        if (result.win) {
                            if (window.ContributionHall && window.ContributionHall.bosses) {
                                const boss = window.ContributionHall.bosses.find(b => b.id === bossId);
                                if (boss) {
                                    const pWin = window.parent || window;

                                    // CRITICAL FIX: Sync state from storage first!
                                    // 123.html might have saved new HP/Mana state. 
                                    // If we don't load, our save() will be rejected due to timestamp conflict.
                                    if (pWin.GameStateManager) {
                                        pWin.GameStateManager.load();
                                    }

                                    const state = pWin.gameState || pWin.state || window.state;

                                    if (state) {
                                        // Initialize completed list logic
                                        if (!state.completedChallenges) state.completedChallenges = [];

                                        console.log(`[Faction] Processing battle return. BossID: ${bossId}, Completed: ${state.completedChallenges}`);

                                        // Check if already completed
                                        if (state.completedChallenges.includes(bossId)) {
                                            setTimeout(() => {
                                                alert(`„ÄêÊà∞È¨•Êç∑Â†±„Äë\nÊìäÊïó‰∫Ü ${boss.name}ÔºÅ\n(Ê≠§ÊåëÊàòÂ∑≤ÂÆåÊàêÔºåÁÑ°Ê≥ïÂÜçÊ¨°Áç≤ÂæóÁçéÂãµ)`);
                                            }, 100);
                                        } else {
                                            // First time clear logic
                                            state.completedChallenges.push(bossId);

                                            // Delay alert slightly to allow UI to render
                                            setTimeout(() => {
                                                alert(`„ÄêÊà∞È¨•Êç∑Â†±„Äë\nÊìäÊïó‰∫Ü ${boss.name}ÔºÅ\nÁç≤Âæó ${boss.rewardStones} ÈùàÁü≥, ${boss.rewardContrib} Ë≤¢Áçª, ${boss.rewardRep} ËÅ≤Êúõ„ÄÇ`);
                                            }, 100);

                                            // Awards
                                            // Awards - Explicitly update state to avoid cross-window function issues or 'no faction' checks
                                            state.factionContrib = (state.factionContrib || 0) + boss.rewardContrib;

                                            // Add stones & Rep (Try accessing parent state)
                                            state.spiritStones = (state.spiritStones || 0) + boss.rewardStones; // fixed prop name
                                            state.factionRep = (state.factionRep || 0) + (boss.rewardRep || 0);

                                            // Log it
                                            if (pWin.addLog) {
                                                pWin.addLog(`ÂÆåÊàêÊá∏Ë≥û„Äê${boss.name}„ÄëÔºöÈùàÁü≥+${boss.rewardStones}, Ë≤¢Áçª+${boss.rewardContrib}, ËÅ≤Êúõ+${boss.rewardRep}`, "event");
                                            }

                                            // Update UI if available
                                            if (pWin.updateResourceUI) pWin.updateResourceUI();
                                            if (pWin.renderUI) pWin.renderUI();
                                            if (window.updateFactionUI) window.updateFactionUI();

                                            // Save
                                            if (pWin.GameStateManager) pWin.GameStateManager.save();
                                        }
                                    }
                                }
                            }
                        } else {
                            setTimeout(() => {
                                alert("„ÄêÊåëÊà∞Â§±Êïó„Äë\nÂãùÊïó‰πÉÂÖµÂÆ∂Â∏∏‰∫ãÔºåÂ∞ë‰ø†Ë´ãÈáçÊñ∞‰æÜÈÅé„ÄÇ");
                            }, 100);
                        }
                    } catch (e) {
                        console.error("Error parsing battle result", e);
                    }

                    localStorage.removeItem("battle-result");
                }

                localStorage.removeItem("battle-return-to");

                // Re-open Hall
                openContribHall();
            }
        }, 500); // 500ms delay to ensure everything is loaded
    })();

    function challengeBoss(bossId) {
        const state = (window.parent && window.parent.state) || window.state;
        const boss = window.ContributionHall.bosses.find(b => b.id === bossId);
        if (!boss || !state) return;

        // Á∞°ÂñÆÊà∞È¨•Ë®àÁÆó
        // Áé©ÂÆ∂Êà∞Âäõ
        let playerPower = 0;
        if (typeof window.parent.calcBattlePower === 'function') {
            playerPower = window.parent.calcBattlePower();
        } else {
            // fallback
            playerPower = (state.attack * 2) + (state.defense * 2) + (state.hp / 10);
        }

        // Á∞°ÂñÆÂà§ÂÆöÔºöÊà∞Âäõ > 80% Boss Êà∞ÂäõÂ∞±ÊúâÊ©üÊúÉË¥èÔºåÊà∞Âäõ > Boss ÂøÖË¥è
        // Âä†ÂÖ•Èö®Ê©üÊÄß
        const winChance = Math.min(1.0, (playerPower / boss.power) * 0.8); // Á®çÂæÆÈõ£‰∏ÄÈªû
        const roll = Math.random();

        if (playerPower > boss.power || roll < winChance) {
            // Win
            if (window.parent.addFactionContrib) {
                window.parent.addFactionContrib(boss.rewardContrib, `ÊìäÊïó ${boss.name}`);
            }
            if (window.parent.addResource) {
                // Assuming addResource exists or modify state direclty
                state.spiritStones += boss.rewardStones;
                if (window.parent.addLog) window.parent.addLog(`Áç≤ÂæóÊá∏Ë≥ûÈùàÁü≥Ôºö${boss.rewardStones}`, 'event');
            } else {
                state.spiritStones += boss.rewardStones;
            }

            alert(`Êà∞Âãù‰∫Ü ${boss.name}ÔºÅ\nÁç≤ÂæóË≤¢Áçª ${boss.rewardContrib}ÔºåÈùàÁü≥ ${boss.rewardStones}`);
        } else {
            // Lose
            const dmg = Math.floor(state.maxHp * 0.3);
            state.hp -= dmg;
            if (state.hp < 0) state.hp = 0;
            if (window.parent.renderUI) window.parent.renderUI();

            if (window.parent.addLog) window.parent.addLog(`ÊåëÊà∞ ${boss.name} Â§±ÊïóÔºåÂèó‰∫ÜÈªûËºïÂÇ∑ (HP -${dmg})`, 'bad-event');
            alert(`Â¶ÇÊûú‰∏çÊïµ ${boss.name}ÔºåÁãºÁãΩÈÄÉÂõûÂÆóÈñÄ...\nÁîüÂëΩÊ∏õÂ∞ë ${dmg}`);
        }

        updateFactionUI();
    }

    function playGamble(choice) {
        const state = (window.parent && window.parent.state) || window.state;
        if (!state) {
            console.error("State not found in playGamble");
            alert("ÈåØË™§ÔºöÊâæ‰∏çÂà∞Áé©ÂÆ∂Êï∏Êìö");
            return;
        }

        // Read bet amount from input
        const inputEl = document.getElementById('gamble-bet');
        let cost = 10;
        if (inputEl) {
            cost = parseInt(inputEl.value);
        } else {
            // Fallback for safety
            cost = 10;
        }

        if (isNaN(cost) || cost < 10) {
            alert("ÁÑ°ÊïàÁöÑ‰∏ãÊ≥®ÈáëÈ°çÔºåÊúÄÂ∞ëÈúÄË¶Å 10 ÈùàÁü≥ÔºÅ");
            return;
        }

        if ((state.spiritStones || 0) < cost) {
            alert(`ÈùàÁü≥‰∏çË∂≥ÔºÅ‰Ω†ÈúÄË¶Å ${cost} ÈùàÁü≥ (Áï∂Ââç: ${state.spiritStones || 0})`);
            return;
        }

        // Deduct cost
        state.spiritStones -= cost;

        const gameRes = window.ContributionHall.gamble(null, choice);

        const resDiv = document.getElementById('gamble-result');
        if (gameRes.win) {
            state.spiritStones += cost * 2;
            resDiv.innerHTML = `<span style="color:green">${gameRes.msg} (+${cost}ÈùàÁü≥)</span>`;
            if (window.parent.addLog) window.parent.addLog(`Ë≥≠ÂùäË¥èÈå¢Ôºö${cost}ÈùàÁü≥`, 'event');
        } else {
            resDiv.innerHTML = `<span style="color:red">${gameRes.msg} (-${cost}ÈùàÁü≥)</span>`;
        }
        updateFactionUI();
        if (window.parent.renderUI) window.parent.renderUI();
    }

    function playRPS(myChoice) {
        // 0: scissors, 1: rock, 2: paper
        const state = (window.parent && window.parent.state) || window.state;
        if (!state) return;

        // Read bet amount
        const inputEl = document.getElementById('rps-bet');
        let cost = 10;
        if (inputEl) {
            cost = parseInt(inputEl.value);
        }

        if (isNaN(cost) || cost < 10) {
            alert("ÁÑ°ÊïàÁöÑ‰∏ãÊ≥®ÈáëÈ°çÔºåÊúÄÂ∞ëÈúÄË¶Å 10 Ë≤¢ÁçªÔºÅ");
            return;
        }

        if ((state.factionContrib || 0) < cost) {
            alert(`Ë≤¢Áçª‰∏çË∂≥ÔºÅ‰Ω†ÈúÄË¶Å ${cost} Ë≤¢Áçª (Áï∂Ââç: ${state.factionContrib || 0})`);
            return;
        }

        // Deduct cost
        state.factionContrib -= cost;

        const res = window.ContributionHall.rps(myChoice);
        const resDiv = document.getElementById('rps-result');

        let color = '#333';
        let txt = '';

        if (res.result === 'win') {
            color = 'green';
            // Reward: Bet * 2
            const reward = cost * 2;
            state.factionContrib += reward;
            txt = `Èï∑ËÄÅÂá∫${res.elderChoiceName}Ôºå‰Ω†Ë¥è‰∫ÜÔºÅ (+${cost}Ë≤¢Áçª)`;
            if (window.parent.addLog) window.parent.addLog(`ÁåúÊã≥Áç≤ÂãùÔºö${cost}Ë≤¢Áçª`, 'event');
        } else if (res.result === 'lose') {
            color = 'red';
            txt = `Èï∑ËÄÅÂá∫${res.elderChoiceName}Ôºå‰Ω†Ëº∏‰∫Ü... (-${cost}Ë≤¢Áçª)`;
        } else {
            color = '#fbc02d';
            // Draw: Refund bet
            state.factionContrib += cost;
            txt = `Èï∑ËÄÅÂá∫${res.elderChoiceName}ÔºåÂπ≥Êâã„ÄÇ (ÈÄÄÈÇÑ‰∏ãÊ≥®)`;
        }

        resDiv.innerHTML = `<span style="color:${color}">${txt}</span>`;
        updateFactionUI();
    }

    // 1. ÂêåÊ≠•ËàáÂàùÂßãÂåñ
    // ÈõñÁÑ∂ main.js ÊòØÁà∂Ë¶ñÁ™óÔºå‰ΩÜ iframe ÂÖßÁöÑ JS Áí∞Â¢ÉÊòØÁç®Á´ãÁöÑ„ÄÇ
    // ÈÄôË£°ÊàëÂÄë‰∏çÈúÄÂº∑Âà∂ÂêåÊ≠•Áâ©‰ª∂ÔºåÂõ†ÁÇ∫Â§ßÂÆ∂ÁèæÂú®ÈÉΩËµ∞ global vars + localStorage„ÄÇ
    // ‰ΩÜÁÇ∫‰∫ÜÁ¢∫‰øùÈ°ØÁ§∫Ê≠£Á¢∫ÔºåÊàëÂÄëÂòóË©¶Âæû parent ËÆÄËÆäÊï∏ (Â¶ÇÊûúÊúâÁöÑË©±) ÊàñËÄÖ load„ÄÇ

    // Â¶ÇÊûú parent Â∑≤Á∂ìËºâÂÖ• state.js ‰∏îÊúâ globalsÔºåÊàëÂÄëÂèØ‰ª•ËÄÉÊÖÆÁõ¥Êé•ËÆÄ parent ÁöÑÔºü
    // ‰ΩÜÁÇ∫‰∫ÜÁ∞°ÂñÆÔºåËÆì iframe ‰πüË∑ëËá™Â∑±ÁöÑ state.js (Â∑≤Âú® head ÈÇÑÊòØÂì™Ë£°ËºâÂÖ•?)
    // Ê™¢Êü•: faction.html Ê≤íÊúâËºâÂÖ• state.js!
    // -> Â¶ÇÊûúÊ≤íÊúâËºâÂÖ• state.jsÔºåÈÇ£ iframe Ë£°Ê†πÊú¨Ê≤íÊúâ GameStateManager„ÄÇ
    // -> ÂøÖÈ†àÁ¢∫Ë™ç faction.html ÊòØÂê¶ÊúâËºâÂÖ• state.js„ÄÇ
    // ÂõûÈ†≠Áúã lines 1-800ÔºåÊ≤íÁúãÂà∞ script src="state.js"„ÄÇ
    // Â¶ÇÊûúÊ≤íËºâÂÖ•ÔºåÈÇ£‰∏äÈù¢ÁöÑ sync code ‰ª•ÂâçÊòØÊÄéÈ∫ºË∑ëÁöÑÔºü
    // "window.gameState = window.parent.gameState" -> ÂÆÉÁõ¥Êé•Áî® parent ÁöÑÁâ©‰ª∂„ÄÇ
    // ÁèæÂú® object Ê≤í‰∫ÜÔºåËÆäÊï∏Âú® parent window ‰∏ä„ÄÇ
    // ÊâÄ‰ª• iframe ÂøÖÈ†àÁõ¥Êé•Â≠òÂèñ parent.variable„ÄÇ
    // ÊàñËÄÖ iframe Ëá™Â∑±ËºâÂÖ• state.js„ÄÇ

    // Ê™¢Êü• line 954 ‰∏ãÈù¢ÁöÑ code.
    // ÁµêË´ñÔºöfaction.html ÊáâË©≤Âè™ÊòØ‰∏ÄÂÄãÂ∞éËà™È†ÅÔºå‰∏çÈúÄË¶ÅÈ°ØÁ§∫Êï∏ÂÄºÔºü
    // ÂÆÉÂè™È°ØÁ§∫ "ÂäüÊ≥ïÈñ£" "Ê¶ÆË≠ΩÂ†Ç"„ÄÇ
    // ÊâÄ‰ª•ÂÖ∂ÂØ¶‰∏çÈúÄË¶Å state„ÄÇ
    // Âè™Ë¶ÅËÉΩË∑≥ËΩâÂ∞±Â•Ω„ÄÇ

    // Âà™Èô§ËàäÁöÑ sync blockÔºåÊîπÁÇ∫Êñ∞ÁöÑ updateUI
    console.log("‚úÖ Faction navigation loaded.");

    function updateFactionUI() {
        const state = (window.parent && window.parent.state) || window.state;
        if (!state) return;

        const fNameEl = document.getElementById('f-name');
        const fRankEl = document.getElementById('f-rank');
        const fContribEl = document.getElementById('f-contrib');
        const fStonesEl = document.getElementById('f-stones'); // New

        // Mapping faction IDs to Names (Simple check)
        let factionName = "ÁÑ°ÈñÄÁÑ°Ê¥æ";
        if (state.faction === 'qingyun') factionName = "ÈùíÈõ≤ÂÆó";
        if (state.faction === 'moyun') factionName = "È≠îÈõ≤ÊÆø"; // Add missing
        if (state.faction === 'danmeng') factionName = "‰∏πÁõü"; // Add missing

        if (fNameEl) fNameEl.textContent = factionName;
        if (fRankEl) fRankEl.textContent = state.factionRank || "ÁÑ°";
        if (fContribEl) fContribEl.textContent = state.factionContrib || 0;
        if (fStonesEl) fStonesEl.textContent = state.spiritStones || 0;

        // Run validation in case balance changed
        validateGambleBet();
        validateRPSBet();
    }

    // Call on load
    window.addEventListener('load', updateFactionUI);
    // Also try immediately in case load event missed
    updateFactionUI();

    function validateGambleBet() {
        const state = (window.parent && window.parent.state) || window.state;
        const input = document.getElementById('gamble-bet');
        const error = document.getElementById('gamble-error');
        if (!state || !input || !error) return;

        const cost = parseInt(input.value) || 0;
        const owned = state.spiritStones || 0;

        if (cost > owned) {
            error.style.display = 'inline';
            error.textContent = `‰∏çË∂≥ (ÊìÅÊúâ: ${owned})`;
        } else {
            error.style.display = 'none';
        }
    }

    function validateRPSBet() {
        const state = (window.parent && window.parent.state) || window.state;
        const input = document.getElementById('rps-bet');
        const error = document.getElementById('rps-error');
        if (!state || !input || !error) return;

        const cost = parseInt(input.value) || 0;
        const owned = state.factionContrib || 0;

        if (cost > owned) {
            error.style.display = 'inline';
            error.textContent = `‰∏çË∂≥ (ÊìÅÊúâ: ${owned})`;
        } else {
            error.style.display = 'none';
        }

    }

    // 2. Â∞éËà™ÂáΩÂºè
    function navigateTo(page) {
        if (window.parent && window.parent.document) {
            const frame = window.parent.document.getElementById("faction-frame");
            if (frame) {
                frame.src = page;
                return;
            }
        }
        window.location.href = page;
    }

    function goBook() {
        navigateTo("skill-hall.html");
    }

    function goHonor() {
        navigateTo("honor-hall.html");
    }

    function goPool() {
        navigateTo("xianling-pool.html");
    }

    // 3. ÈõñÁÑ∂ÊåâÈàïÈÇèËºØÂú® main.jsÔºå‰ΩÜÈÄôË£°‰øùÁïôÂ∞ç iframe ÂÖßÈÉ®ÂèØËÉΩÁöÑËøîÂõûÊåâÈàïËôïÁêÜ (Â¶ÇÊûúÊúâ)
    // ÁõÆÂâç‰∏ªË¶Å‰æùË≥¥ index.html ÁöÑÊá∏ÊµÆÊåâÈàï
</script>

</html>