<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8" />
    <title>ä¿®ä»™å®—é–€å ´æ™¯ â€“ åŠŸæ³•é–£ / æ¦®è­½å ‚ / ä»™éˆæ± </title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            margin: 0;
            height: 100vh;
            overflow: hidden;
            font-family: "Noto Sans TC", "Microsoft JhengHei", system-ui, sans-serif;
            background: radial-gradient(circle at top, #f5f3ea 0, #e5e0d3 35%, #d0cabd 100%);
        }

        /* ===== æ•´é«”å ´æ™¯ ===== */
        .scene {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        /* â­ è¿”å›æŒ‰éˆ• */
        .back-btn {
            position: absolute;
            top: 18px;
            left: 26px;
            padding: 6px 18px;
            border-radius: 18px;
            background: rgba(26, 18, 16, 0.78);
            color: #f6e7c6;
            border: 1px solid rgba(246, 231, 198, 0.85);
            cursor: pointer;
            font-size: 13px;
            letter-spacing: 2px;
            z-index: 20;
        }

        .back-btn:hover {
            background: rgba(40, 28, 24, 0.9);
            box-shadow: 0 0 8px rgba(246, 231, 198, 0.7);
        }

        /* ===== é æ™¯å±±è„ˆ ===== */
        .bg-mountain {
            position: absolute;
            bottom: -10vh;
            width: 50vw;
            height: 55vh;
            background: linear-gradient(to top, #a19c8d 0, #d5d0c3 60%, #f3f0e7 100%);
            border-radius: 60% 40% 0 0;
            opacity: 0.7;
            filter: blur(1px);
        }

        .bg-mountain.left {
            left: -10vw;
        }

        .bg-mountain.right {
            right: -15vw;
        }

        /* ===== é›²éœ§ ===== */
        .cloud {
            position: absolute;
            width: 220px;
            height: 60px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 40px;
            filter: blur(1px);
            opacity: 0.9;
            box-shadow:
                40px 8px 0 rgba(255, 255, 255, 0.9),
                90px -6px 0 rgba(255, 255, 255, 0.85);
            animation: drift 60s linear infinite;
        }

        .cloud.small {
            width: 160px;
            height: 45px;
            box-shadow:
                30px 6px 0 rgba(255, 255, 255, 0.9),
                70px -4px 0 rgba(255, 255, 255, 0.85);
        }

        .cloud.c1 {
            top: 14vh;
            left: -25vw;
            animation-delay: 0s;
        }

        .cloud.c2 {
            top: 28vh;
            left: -40vw;
            animation-delay: 8s;
        }

        .cloud.c3 {
            top: 8vh;
            left: -50vw;
            animation-delay: 18s;
        }

        .cloud.c4 {
            top: 36vh;
            left: -35vw;
            animation-delay: 28s;
        }

        @keyframes drift {
            from {
                transform: translateX(0);
            }

            to {
                transform: translateX(170vw);
            }
        }

        /* ===== æ‡¸æµ®å³¶å…±ç”¨æ¨£å¼ ===== */
        .floating-island {
            position: absolute;
            width: 260px;
            height: 70px;
            background: linear-gradient(to bottom, #a2967a 0, #6c5f4a 60%, #4d4236 100%);
            border-radius: 60% 60% 50% 50%;
            box-shadow:
                0 10px 25px rgba(0, 0, 0, 0.4),
                0 -6px 10px rgba(255, 255, 255, 0.35) inset;
        }

        .floating-island::after {
            content: "";
            position: absolute;
            left: 15%;
            right: 15%;
            top: 30px;
            height: 80px;
            background: linear-gradient(to bottom, #756653 0, #4b4033 100%);
            clip-path: polygon(10% 0, 90% 0, 70% 40%, 60% 80%, 45% 100%, 30% 80%, 20% 40%);
            opacity: 0.95;
        }

        .island-left {
            bottom: 14vh;
            left: 6vw;
        }

        .island-mid {
            bottom: 18vh;
            left: 50%;
            transform: translateX(-50%);
        }

        .island-right {
            bottom: 12vh;
            right: 6vw;
        }

        /* ===== å…±ç”¨ï¼šå»ºç¯‰ä¸Šæ–¹åŒ¾é¡ ===== */
        .building-sign {
            position: absolute;
            top: -90px;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 2px;
            border-radius: 16px;
            background: #2b1a16;
            border: 2px solid #f1d38f;
            color: #f6e7c6;
            font-size: 14px;
            letter-spacing: 4px;
            box-shadow:
                0 0 0 1px #674430 inset,
                0 4px 6px rgba(0, 0, 0, 0.5);
        }

        /* =========================
   å·¦å´ï¼šåŠŸæ³•é–£ï¼ˆè—æ›¸æ¨“ï¼‰
   ========================= */
        .temple-left-wrapper {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 170px;
            height: 160px;
        }

        /* å°éšèˆ‡æŸ±å­ */
        .temple-base {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 130px;
            height: 30px;
            background: linear-gradient(to top, #b99c7a 0, #e2c8a3 70%);
            border-radius: 4px;
            box-shadow:
                0 0 0 2px #7e5f4b inset,
                0 7px 8px rgba(0, 0, 0, 0.4);
        }

        .temple-pillars {
            position: absolute;
            bottom: 18px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 58px;
            display: flex;
            justify-content: space-between;
            padding: 0 8px;
        }

        .temple-pillar {
            width: 10px;
            background: linear-gradient(to right, #6d3024 0, #8c3d2d 40%, #5a241a 100%);
            border-radius: 4px;
            box-shadow:
                0 0 0 1px #3a1510 inset,
                0 4px 6px rgba(0, 0, 0, 0.5);
        }

        /* é–€æ´ */
        .temple-door {
            position: absolute;
            bottom: 18px;
            left: 50%;
            transform: translateX(-50%);
            width: 54px;
            height: 46px;
            background: #2b1c1a;
            border-radius: 2px 2px 0 0;
            box-shadow:
                0 0 0 2px #5d3c2f inset,
                0 2px 4px rgba(0, 0, 0, 0.7);
        }

        /* å¤šå±¤å±‹é ‚ */
        .temple-roof {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            height: 22px;
            background: linear-gradient(to bottom, #8d3f32 0, #4a1c18 100%);
            border-radius: 24px 24px 4px 4px;
            box-shadow:
                0 4px 0 #371412,
                0 8px 8px rgba(0, 0, 0, 0.4);
        }

        .temple-roof.r1 {
            bottom: 65px;
            width: 146px;
        }

        .temple-roof.r2 {
            bottom: 94px;
            width: 118px;
        }

        .temple-roof.r3 {
            bottom: 122px;
            width: 90px;
        }

        .temple-roof::before,
        .temple-roof::after {
            content: "";
            position: absolute;
            bottom: 4px;
            width: 22px;
            height: 18px;
            background: linear-gradient(to bottom, #a54a39 0, #4a1c18 100%);
            transform-origin: center bottom;
        }

        .temple-roof::before {
            left: -10px;
            transform: rotate(-16deg);
        }

        .temple-roof::after {
            right: -10px;
            transform: rotate(16deg);
        }

        /* é ‚ç«¯å°å¡” */
        .temple-top-tower {
            position: absolute;
            bottom: 145px;
            left: 50%;
            transform: translateX(-50%);
            width: 32px;
            height: 40px;
            background: #c8b49b;
            border-radius: 4px 4px 0 0;
            box-shadow: 0 0 0 2px #7f664e inset;
        }

        .temple-top-tower::before {
            content: "";
            position: absolute;
            bottom: 30px;
            left: -10px;
            right: -10px;
            height: 18px;
            background: linear-gradient(to bottom, #8d3f32 0, #4a1c18 100%);
            border-radius: 18px 18px 4px 4px;
            box-shadow:
                0 3px 0 #371412,
                0 6px 6px rgba(0, 0, 0, 0.4);
        }

        .temple-top-tower::after {
            content: "";
            position: absolute;
            bottom: 52px;
            left: 50%;
            transform: translateX(-50%);
            width: 18px;
            height: 18px;
            background: #4a1c18;
            clip-path: polygon(50% 0, 100% 100%, 0 100%);
        }

        /* æ‡¸æ›ç‡ˆç±  */
        .lantern-row {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            width: 140px;
            display: flex;
            justify-content: space-around;
        }

        .lantern {
            width: 12px;
            height: 18px;
            background: radial-gradient(circle at 50% 20%, #fff6d2 0, #f89b3a 45%, #c34a1f 100%);
            border-radius: 50% 50% 40% 40%;
            box-shadow: 0 0 8px rgba(255, 180, 90, 0.7);
            position: relative;
        }

        .lantern::before {
            content: "";
            position: absolute;
            top: -6px;
            left: 50%;
            width: 2px;
            height: 6px;
            background: #4a1c18;
            transform: translateX(-50%);
        }

        .lantern::after {
            content: "";
            position: absolute;
            bottom: -4px;
            left: 50%;
            width: 6px;
            height: 4px;
            background: #c34a1f;
            transform: translateX(-50%);
        }

        /* =========================
   ä¸­å¤®ï¼šæ¦®è­½å ‚ï¼ˆå®—é–€å¤§é–€ï¼‰
   ========================= */
        .gate {
            position: absolute;
            bottom: 38px;
            left: 50%;
            transform: translateX(-50%);
            width: 220px;
            height: 160px;
            cursor: pointer;
            /* åŠ å€‹æ‰‹å½¢ */
        }

        /* åŒ¾é¡ï¼šæ¦®è­½å ‚ */
        .gate .building-sign {
            top: -55px;
        }

        /* çŸ³å°éš */
        .gate-base {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 160px;
            height: 26px;
            background: linear-gradient(to top, #b4a48e 0, #e2d8c4 70%);
            border-radius: 3px;
            box-shadow:
                0 0 0 2px #8a7a65 inset,
                0 7px 8px rgba(0, 0, 0, 0.45);
        }

        /* å…©å´å¤§æŸ± */
        .gate-column {
            position: absolute;
            bottom: 24px;
            width: 40px;
            height: 110px;
            background: linear-gradient(to right, #864632 0, #b56a4a 40%, #6f3628 100%);
            box-shadow:
                0 0 0 2px #4b1e18 inset,
                0 6px 10px rgba(0, 0, 0, 0.55);
            border-radius: 4px;
        }

        .gate-column.left {
            left: 22px;
        }

        .gate-column.right {
            right: 22px;
        }

        .gate-column::before {
            content: "";
            position: absolute;
            inset: 14px 7px;
            border-radius: 4px;
            border: 1px solid rgba(250, 214, 142, 0.7);
            opacity: 0.9;
        }

        .gate-column::after {
            content: "";
            position: absolute;
            bottom: -26px;
            left: 50%;
            transform: translateX(-50%);
            width: 26px;
            height: 32px;
            background: #6d3a2d;
            clip-path: polygon(0 0, 100% 0, 50% 100%);
            box-shadow:
                0 0 0 1px #3a1714 inset,
                0 6px 8px rgba(0, 0, 0, 0.6);
        }

        /* å´ç¿¼é£›æª */
        .gate-wing {
            position: absolute;
            bottom: 98px;
            width: 86px;
            height: 20px;
            background: linear-gradient(to bottom, #8d3f32 0, #4a1c18 100%);
            border-radius: 20px 20px 4px 4px;
            box-shadow:
                0 3px 0 #371412,
                0 7px 6px rgba(0, 0, 0, 0.45);
        }

        .gate-wing.left {
            left: -4px;
        }

        .gate-wing.right {
            right: -4px;
        }

        .gate-wing::before,
        .gate-wing::after {
            content: "";
            position: absolute;
            bottom: 3px;
            width: 20px;
            height: 16px;
            background: linear-gradient(to bottom, #a54a39 0, #4a1c18 100%);
            transform-origin: center bottom;
        }

        .gate-wing::before {
            left: -10px;
            transform: rotate(-16deg);
        }

        .gate-wing::after {
            right: -10px;
            transform: rotate(16deg);
        }

        /* ä¸­å¤®æ©«æ¨‘ */
        .gate-top {
            position: absolute;
            bottom: 104px;
            left: 28px;
            right: 28px;
            height: 26px;
            background: linear-gradient(to bottom, #7c4033 0, #4b221f 100%);
            box-shadow:
                0 4px 0 #321312,
                0 8px 8px rgba(0, 0, 0, 0.4);
        }

        /* ä¸Šæ–¹æ‹±å½¢å±‹é ‚ */
        .gate-crest {
            position: absolute;
            bottom: 132px;
            left: 50%;
            transform: translateX(-50%);
            width: 130px;
            height: 40px;
            background: #7c4033;
            border-radius: 60px 60px 12px 12px;
            box-shadow:
                0 4px 0 #4b221f,
                0 12px 10px rgba(0, 0, 0, 0.45);
        }

        .gate-crest::before,
        .gate-crest::after {
            content: "";
            position: absolute;
            bottom: 6px;
            width: 30px;
            height: 20px;
            background: linear-gradient(to bottom, #a54a39 0, #4a1c18 100%);
            transform-origin: center bottom;
        }

        .gate-crest::before {
            left: -16px;
            transform: rotate(-18deg);
        }

        .gate-crest::after {
            right: -16px;
            transform: rotate(18deg);
        }

        /* é‡‘è‰²å…§æ¡† */
        .gate-crest-inner {
            position: absolute;
            bottom: 138px;
            left: 50%;
            transform: translateX(-50%);
            width: 110px;
            height: 28px;
            border-radius: 30px;
            border: 2px solid #f4d79e;
        }

        /* ä¸­å¤®æ‡¸æµ®å…‰ç’° */
        .gate-ring {
            position: absolute;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: 3px solid rgba(255, 200, 120, 0.9);
            box-shadow:
                0 0 9px rgba(255, 210, 140, 0.9),
                0 0 18px rgba(255, 210, 140, 0.7);
        }

        /* =========================
   å³å´ï¼šä»™éˆæ± 
   ========================= */
        .spirit-pool-wrapper {
            position: absolute;
            bottom: 26px;
            left: 50%;
            transform: translateX(-50%);
            width: 180px;
            height: 130px;
        }

        /* çŸ³åŸºåº§ */
        .pool-base {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 140px;
            height: 26px;
            background: linear-gradient(to top, #bca88d 0, #e6d5bd 70%);
            border-radius: 10px;
            box-shadow:
                0 0 0 2px #7a644e inset,
                0 6px 8px rgba(0, 0, 0, 0.45);
        }

        /* éˆæ± å¤–åœˆ */
        .pool-ring {
            position: absolute;
            bottom: 18px;
            left: 50%;
            transform: translateX(-50%);
            width: 130px;
            height: 50px;
            background: radial-gradient(circle at 50% 40%, #f7f4ee 0, #c5b8a2 80%);
            border-radius: 50%;
            box-shadow:
                0 0 0 2px #9a8871 inset,
                0 3px 6px rgba(0, 0, 0, 0.4);
        }

        /* éˆæ± æ°´é¢ */
        .pool-water {
            position: absolute;
            bottom: 26px;
            left: 50%;
            transform: translateX(-50%);
            width: 114px;
            height: 34px;
            background: radial-gradient(circle at 50% 20%, #b9f7ff 0, #67c3d6 45%, #3a7f95 90%);
            border-radius: 50%;
            box-shadow:
                0 0 10px rgba(120, 220, 240, 0.8),
                0 0 18px rgba(110, 200, 230, 0.6);
        }

        /* éˆåŠ›æ—‹æ¸¦ */
        .pool-ripple {
            position: absolute;
            inset: 6px 14px;
            border-radius: 50%;
            border: 1px dashed rgba(255, 255, 255, 0.7);
            opacity: 0.7;
            animation: rippleSpin 10s linear infinite;
        }

        @keyframes rippleSpin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* ä¸­å¤®éˆæŸ± */
        .spirit-pillar {
            position: absolute;
            bottom: 52px;
            left: 50%;
            transform: translateX(-50%);
            width: 26px;
            height: 70px;
            background: linear-gradient(to top, #f2f1ef 0, #ffffff 40%);
            border-radius: 20px;
            box-shadow:
                0 0 0 2px #d6cec4 inset,
                0 0 16px rgba(165, 240, 255, 0.9);
        }

        /* éˆæŸ±é ‚ç«¯å…‰ç’° */
        .spirit-ring {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid rgba(192, 248, 255, 0.9);
            box-shadow:
                0 0 8px rgba(180, 245, 255, 0.9),
                0 0 18px rgba(180, 245, 255, 0.7);
        }

        /* éˆç« */
        .spirit-flame {
            position: absolute;
            top: -22px;
            left: 50%;
            transform: translateX(-50%);
            width: 18px;
            height: 26px;
            background: radial-gradient(circle at 50% 20%, #ffffff 0, #fffac5 30%, #8ef1ff 60%, #2da0ff 90%);
            clip-path: polygon(50% 0, 100% 40%, 70% 100%, 30% 100%, 0 40%);
            box-shadow: 0 0 16px rgba(160, 240, 255, 0.9);
        }

        /* =========================
           æ–°å¢ï¼šè—å¯¶é–£ï¼ˆå•†åº—ï¼‰
           ========================= */
        .island-shop {
            bottom: 22vh;
            left: 72%;
            transform: translateX(-50%);
            z-index: 5;
        }

        .shop-wrapper {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 160px;
            height: 140px;
            cursor: pointer;
        }

        .shop-base {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 24px;
            background: #5d4037;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
        }

        .shop-body {
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 80px;
            background: #795548;
            border: 2px solid #3e2723;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* é‡‘è‰²å±‹é ‚ */
        .shop-roof {
            position: absolute;
            bottom: 104px;
            left: 50%;
            transform: translateX(-50%);
            width: 140px;
            height: 30px;
            background: linear-gradient(to bottom, #ffecb3 0%, #ffca28 100%);
            border-radius: 40px 40px 4px 4px;
            box-shadow: 0 4px 0 #ff6f00, 0 8px 8px rgba(0, 0, 0, 0.4);
        }

        .shop-roof::before {
            content: "";
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 20px;
            background: #ffca28;
            border-radius: 50%;
            border: 2px solid #ff6f00;
        }

        /* é–€ç°¾å¤§å¤§çš„ "å¯¶" å­— */
        .shop-sign-text {
            color: #ffca28;
            font-size: 24px;
            font-weight: bold;
            border: 2px solid #ffca28;
            padding: 4px;
            border-radius: 4px;
            background: #3e2723;
        }

        /* ===== LOGO ===== */
        .logo {
            position: absolute;
            top: 20px;
            right: 40px;
            font-size: 28px;
            letter-spacing: 4px;
            color: #3c2c22;
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }

        .logo span.red {
            color: #b23118;
            font-size: 18px;
            border: 1px solid #b23118;
            padding: 2px 3px;
            margin-bottom: 4px;
        }

        /* ä¸­æ™¯å±±ï¼ˆåœ¨ä¸­é–“åå·¦å³ï¼‰ */
        .bg-mountain.mid {
            width: 35vw;
            height: 45vh;
            opacity: 0.8;
        }

        /* å°ä¸€é»çš„å±±å³° */
        .bg-mountain.small-peak {
            width: 22vw;
            height: 38vh;
            opacity: 0.9;
            filter: blur(0.5px);
        }

        /* ====== æ–°å¢ï¼šæ•´æ’å±±è„ˆ ====== */

        /* é å±±ï¼ˆæœ€æ·¡ã€æœ€å¤§ï¼‰ */
        .mountain-range-back {
            position: absolute;
            bottom: -5vh;
            left: 0;
            width: 200vw;
            height: 40vh;
            background: radial-gradient(circle at 50% 120%, #e1ddd3 0%, #c9c3b8 70%, transparent 100%);
            opacity: 0.55;
            transform: translateX(-20vw);
            filter: blur(2px);
            z-index: 0;
        }

        /* ä¸­æ™¯å±±ï¼ˆè¼ƒæ·±ã€æœ‰èµ·ä¼ï¼‰ */
        .mountain-range-mid {
            position: absolute;
            bottom: -6vh;
            left: 0;
            width: 200vw;
            height: 32vh;
            background: #b8ae9e;
            clip-path: polygon(0% 60%, 10% 45%, 25% 55%, 35% 38%, 50% 52%,
                    65% 40%, 75% 60%, 90% 42%, 100% 55%, 100% 100%, 0% 100%);
            opacity: 0.75;
            z-index: 1;
        }

        /* è¿‘æ™¯å±±ï¼ˆæ·±è‰²ã€ä½é«˜åº¦ï¼‰ */
        .mountain-range-front {
            position: absolute;
            bottom: -4vh;
            left: 0;
            width: 200vw;
            height: 20vh;
            background: #8a7f6f;
        }

        /* ===== æ°´å¢¨å±±è„ˆï¼šä¸‰å±¤å±± + éœ§ ===== */

        /* é è™•æ·¡è—å±±è„ˆ */
        .ink-mountain-back {
            position: absolute;
            bottom: -10vh;
            left: -10vw;
            width: 140vw;
            height: 55vh;
            background: #c7d9e7;
            clip-path: polygon(0% 80%, 5% 65%, 12% 70%, 18% 55%, 25% 60%,
                    33% 50%, 42% 58%, 50% 40%, 60% 55%, 70% 48%,
                    78% 60%, 88% 52%, 95% 65%, 100% 60%,
                    100% 100%, 0% 100%);
            opacity: 0.55;
            filter: blur(1.5px);
        }

        /* ä¸­æ™¯ç°å±±è„ˆ */
        .ink-mountain-mid {
            position: absolute;
            bottom: -8vh;
            left: -10vw;
            width: 140vw;
            height: 45vh;
            background: #b8c0c7;
            clip-path: polygon(0% 85%, 6% 70%, 15% 75%, 24% 62%, 32% 68%,
                    41% 58%, 52% 64%, 61% 55%, 72% 63%, 82% 57%,
                    92% 68%, 100% 62%, 100% 100%, 0% 100%);
            opacity: 0.7;
            filter: blur(1px);
        }

        /* å‰æ™¯æ·±å±±å‰ªå½± */
        .ink-mountain-front {
            position: absolute;
            bottom: -6vh;
            left: -10vw;
            width: 140vw;
            height: 35vh;
            background: #9f968a;
            clip-path: polygon(0% 90%, 8% 78%, 18% 82%, 28% 72%, 40% 78%,
                    52% 70%, 64% 80%, 76% 72%, 88% 82%, 100% 76%,
                    100% 100%, 0% 100%);
            opacity: 0.9;
        }

        /* å±±è…°ç™½éœ§ */
        .ink-mountain-fog {
            position: absolute;
            bottom: 10vh;
            left: -10vw;
            width: 140vw;
            height: 20vh;
            background:
                radial-gradient(circle at 15% 100%, rgba(255, 255, 255, 0.9), transparent 60%),
                radial-gradient(circle at 45% 110%, rgba(255, 255, 255, 0.9), transparent 60%),
                radial-gradient(circle at 80% 95%, rgba(255, 255, 255, 0.9), transparent 60%);
            opacity: 0.85;
            filter: blur(4px);
        }

        /* ===============================
   å»ºç¯‰ Hover æ”¾å¤§ + ä¸Šå‡ æ•ˆæœ
   =============================== */
        .temple-left-wrapper,
        .gate,
        .spirit-pool-wrapper,
        .shop-wrapper {
            transition: transform 0.28s ease-out, filter 0.28s ease-out;
            transform-origin: center bottom;
        }

        /* æ»‘é¼ ç§»ä¸Šå»ï¼šå¾®å¾®æ”¾å¤§ + ä¸Šå‡ */
        .temple-left-wrapper:hover,
        .gate:hover,
        .spirit-pool-wrapper:hover,
        .shop-wrapper:hover {
            transform: translateX(-50%) scale(1.04);
            filter: brightness(1.08);
        }

        /* åŒ¾é¡äº®ä¸€é» */
        .temple-left-wrapper:hover .building-sign,
        .gate:hover .building-sign,
        .spirit-pool-wrapper:hover .building-sign,
        .shop-wrapper:hover .building-sign {
            filter: brightness(1.18);
        }
    </style>
</head>

<body>
    <div class="scene">

        <div class="mountain-range-back"></div>
        <div class="mountain-range-mid"></div>
        <div class="mountain-range-front"></div>

        <!-- é æ–¹å±±è„ˆ -->
        <div class="bg-mountain left"></div>
        <div class="bg-mountain right"></div>

        <div class="ink-mountain-back"></div>
        <div class="ink-mountain-mid"></div>
        <div class="ink-mountain-front"></div>
        <div class="ink-mountain-fog"></div>

        <!-- é£„å‹•é›²éœ§ -->
        <div class="cloud c1"></div>
        <div class="cloud small c2"></div>
        <div class="cloud small c3"></div>
        <div class="cloud c4"></div>

        <!-- ä¸­æ™¯å±± -->
        <div class="bg-mountain mid" style="left:18vw; bottom:-8vh;"></div>
        <div class="bg-mountain mid" style="right:20vw; bottom:-6vh;"></div>

        <!-- å°å±±å³° -->
        <div class="bg-mountain small-peak" style="left:35vw; bottom:-4vh;"></div>
        <div class="bg-mountain small-peak" style="right:34vw; bottom:-5vh;"></div>

        <!-- å·¦å´æ‡¸æµ®å³¶ï¼šåŠŸæ³•é–£ -->
        <div class="floating-island island-left">
            <div class="temple-left-wrapper" onclick="goBook()">
                <div class="building-sign">åŠŸæ³•é–£</div>
                <div class="temple-base"></div>
                <div class="temple-pillars">
                    <div class="temple-pillar"></div>
                    <div class="temple-pillar"></div>
                    <div class="temple-pillar"></div>
                    <div class="temple-pillar"></div>
                </div>
                <div class="temple-door"></div>
                <div class="temple-roof r1"></div>
                <div class="temple-roof r2"></div>
                <div class="temple-roof r3"></div>
                <div class="lantern-row">
                    <div class="lantern"></div>
                    <div class="lantern"></div>
                    <div class="lantern"></div>
                </div>
                <div class="temple-top-tower"></div>
            </div>
        </div>

        <!-- ä¸­å¤®æ‡¸æµ®å³¶ï¼šæ¦®è­½å ‚ -->
        <div class="floating-island island-mid">
            <!-- â­ é€™è£¡åŠ  onclick="goHonor()" â­ -->
            <div class="gate" onclick="goHonor()">
                <div class="building-sign">æ¦®è­½å ‚</div>
                <div class="gate-base"></div>
                <div class="gate-column left"></div>
                <div class="gate-column right"></div>
                <div class="gate-top"></div>
                <div class="gate-wing left"></div>
                <div class="gate-wing right"></div>
                <div class="gate-crest"></div>
                <div class="gate-crest-inner"></div>
                <div class="gate-ring"></div>
            </div>
        </div>

        <!-- å³å´æ‡¸æµ®å³¶ï¼šä»™éˆæ±  -->
        <div class="floating-island island-right">
            <div class="spirit-pool-wrapper" onclick="goPool()">
                <div class="building-sign">ä»™éˆæ± </div>
                <div class="pool-base"></div>
                <div class="pool-ring"></div>
                <div class="pool-water">
                    <div class="pool-ripple"></div>
                </div>
                <div class="spirit-pillar">
                    <div class="spirit-ring"></div>
                    <div class="spirit-flame"></div>
                </div>
            </div>
        </div>

        <!-- å³ä¸­ï¼šè—å¯¶é–£ -->
        <div class="floating-island island-shop">
            <div class="shop-wrapper" onclick="openShop()">
                <div class="building-sign">è—å¯¶é–£</div>
                <div class="shop-roof"></div>
                <div class="shop-body">
                    <div class="shop-sign-text"
                        style="color:#ffca28; font-weight:bold; font-size:24px; background:#3e2723; padding:4px; border:1px solid #ffca28;">
                        å¯¶</div>
                </div>
                <div class="shop-base"></div>
            </div>
        </div>

        <!-- å·¦ä¸­ï¼šè²¢ç»å ‚ (æ–°å¢) -->
        <div class="floating-island island-left"
            style="bottom: 22vh; left: 28%; transform: translateX(-50%); z-index: 5;">
            <div class="shop-wrapper" onclick="openContribHall()">
                <div class="building-sign">è²¢ç»å ‚</div>
                <!-- å±‹é ‚æ›å€‹é¡è‰² (é’è‰²/ç°è‰²) -->
                <div class="shop-roof"
                    style="background: linear-gradient(to bottom, #cfd8dc 0%, #90a4ae 100%); box-shadow: 0 4px 0 #546e7a, 0 8px 8px rgba(0,0,0,0.4);">
                </div>
                <div class="shop-body" style="background: #5d4037; border-color: #3e2723;">
                    <div class="shop-sign-text"
                        style="color:#eceff1; font-weight:bold; font-size:24px; background:#455a64; padding:4px; border:1px solid #cfd8dc;">
                        è³</div>
                </div>
                <div class="shop-base"></div>
            </div>
        </div>

        <!-- å³ä¸Šè§’ LOGO é¢¨æ ¼å­—æ¨£ -->
        <div class="logo">
            <span class="red">ä¿®</span>
            ä»™å®—é–€
            <div id="faction-info-panel" style="
                writing-mode: horizontal-tb; 
                direction: ltr;
                font-size: 14px; 
                margin-top: 10px; 
                color: #5d4037;
                background: rgba(255, 255, 255, 0.6);
                padding: 8px 12px;
                border-radius: 6px;
                border: 1px solid #d7ccc8;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                display: flex;
                flex-direction: column;
                gap: 4px;
                align-items: flex-start;
                min-width: 120px;
            ">
                <div
                    style="font-weight: bold; color: #3e2723; border-bottom: 1px solid #a1887f; padding-bottom: 2px; width: 100%;">
                    <span id="f-name">ç„¡é–€ç„¡æ´¾</span>
                </div>
                <div>ä½éšï¼š<span id="f-rank">ç„¡</span></div>
                <div>ä½éšï¼š<span id="f-rank">ç„¡</span></div>
                <div>è²¢ç»ï¼š<span id="f-contrib" style="color: #d84315; font-weight: bold;">0</span></div>
                <div>éˆçŸ³ï¼š<span id="f-stones" style="color: #1976d2; font-weight: bold;">0</span></div>
            </div>
        </div>
    </div>
    <!-- å•†åº—æ¨¡æ…‹æ¡† -->
    <div id="shop-modal" class="modal-overlay"
        style="display: none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:100; justify-content:center; align-items:center;">
        <div class="modal-content"
            style="width: 500px; max-width:90%; background:#fff3e0; padding:20px; border-radius:8px; border:2px solid #5d4037; position:relative;">
            <h2 style="text-align: center; color: #5d4037; margin-bottom: 20px;">å®—é–€è—å¯¶é–£</h2>
            <div style="text-align: right; margin-bottom: 10px; color: #5d4037; font-weight: bold;">
                ç•¶å‰è²¢ç»ï¼š<span id="shop-contrib-display">0</span>
            </div>

            <div id="shop-items-container"
                style="max-height: 400px; overflow-y: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <!-- å•†å“åˆ—è¡¨ -->
            </div>

            <button onclick="closeModal('shop-modal')"
                style="margin-top: 20px; width: 100%; padding: 10px; background: #8d6e63; color: white; border: none; border-radius: 4px; cursor: pointer;">é›¢é–‹</button>
        </div>
    </div>
    <!-- è²¢ç»å ‚æ¨¡æ…‹æ¡† -->
    <div id="contrib-modal" class="modal-overlay"
        style="display: none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:100; justify-content:center; align-items:center;">
        <div class="modal-content"
            style="width: 600px; max-width:90%; background:#eceff1; padding:20px; border-radius:8px; border:2px solid #37474f; position:relative; overflow:hidden;">
            <h2 style="text-align: center; color: #37474f; margin-bottom: 20px;">å®—é–€è²¢ç»å ‚</h2>

            <div class="tabs" style="display:flex; justify-content:center; gap:10px; margin-bottom:15px;">
                <button onclick="switchContribTab('bounty')" id="tab-bounty"
                    style="padding:8px 16px; cursor:pointer; background:#546e7a; color:white; border:none; border-radius:4px;">æ‡¸è³ä»»å‹™</button>
                <button onclick="switchContribTab('minigame')" id="tab-minigame"
                    style="padding:8px 16px; cursor:pointer; background:#90a4ae; color:white; border:none; border-radius:4px;">ä¼‘é–’å¨›æ¨‚</button>
            </div>

            <!-- æ‡¸è³å€åŸŸ -->
            <div id="contrib-section-bounty" style="max-height: 400px; overflow-y: auto;">
                <div id="bounty-list" style="display:grid; gap:10px;"></div>
            </div>

            <!-- å°éŠæˆ²å€åŸŸ -->
            <div id="contrib-section-minigame" style="display:none; text-align:center;">
                <h3>å®—é–€å°éŠæˆ²</h3>
                <p>è¼•é¬†ä¸€ä¸‹ï¼Œè³ºå–å¾®è–„çš„è²¢ç»æˆ–éˆçŸ³ã€‚</p>

                <div style="margin-top:20px; display:flex; flex-direction:column; gap:15px;">
                    <!-- çŒœå¤§å° -->
                    <div style="background:#fff; padding:10px; border-radius:4px; border:1px solid #cfd8dc;">
                        <h4>ğŸ² éˆçŸ³è³­åŠ (çŒœå¤§å°)</h4>
                        <div style="margin-bottom:8px; font-size:12px; color:#666;">
                            ä¸‹æ³¨éˆçŸ³ï¼š
                            <input type="number" id="gamble-bet" value="10" min="10" style="width:60px; padding:2px;"
                                oninput="validateGambleBet()">
                            <span id="gamble-error"
                                style="color:red; font-size:12px; display:none; margin-left:5px;">ä¸è¶³</span>
                            (è´äº†ç¿»å€)
                        </div>
                        <div style="margin-top:10px;">
                            <button onclick="playGamble('low')"
                                style="padding:5px 15px; background:#e57373; color:white; border:none; border-radius:4px; margin-right:5px;">æŠ¼å°
                                (1-3)</button>
                            <button onclick="playGamble('high')"
                                style="padding:5px 15px; background:#64b5f6; color:white; border:none; border-radius:4px;">æŠ¼å¤§
                                (4-6)</button>
                        </div>
                        <div id="gamble-result" style="margin-top:5px; font-weight:bold; height:20px;"></div>
                    </div>

                    <!-- çŒœæ‹³ -->
                    <div style="background:#fff; padding:10px; border-radius:4px; border:1px solid #cfd8dc;">
                        <h4>âœŒï¸ èˆ‡é•·è€çŒœæ‹³</h4>
                        <div style="margin-bottom:8px; font-size:12px; color:#666;">
                            ä¸‹æ³¨è²¢ç»ï¼š
                            <input type="number" id="rps-bet" value="10" min="10" style="width:60px; padding:2px;"
                                oninput="validateRPSBet()">
                            <span id="rps-error"
                                style="color:red; font-size:12px; display:none; margin-left:5px;">ä¸è¶³</span>
                            (è´äº†ç¿»å€)
                        </div>
                        <div style="margin-top:10px;">
                            <button onclick="playRPS(0)"
                                style="font-size:20px; padding:5px 15px; cursor:pointer;">âœ‚ï¸</button>
                            <button onclick="playRPS(1)"
                                style="font-size:20px; padding:5px 15px; cursor:pointer;">âœŠ</button>
                            <button onclick="playRPS(2)"
                                style="font-size:20px; padding:5px 15px; cursor:pointer;">ğŸ–ï¸</button>
                        </div>
                        <div id="rps-result" style="margin-top:5px; font-weight:bold; height:20px;"></div>
                    </div>
                </div>
            </div>

            <button onclick="closeModal('contrib-modal')"
                style="margin-top: 20px; width: 100%; padding: 10px; background: #37474f; color: white; border: none; border-radius: 4px; cursor: pointer;">é›¢é–‹</button>
        </div>
    </div>
</body>
<!-- 3. Load Contribution Logic -->
<script src="contribution.js"></script>
<script>
    // å•†å“åˆ—è¡¨å®šç¾© (Sect Shop items)
    const SectShopList = [
        // === å››è—å…¸ç± (é«˜åƒ¹) ===
        { id: "alchemy_manual", price: 5000, desc: "ç¿’å¾—ç…‰ä¸¹è¡“" },
        { id: "weapon_manual", price: 5000, desc: "ç¿’å¾—ç…‰å™¨è¡“" },
        { id: "formation_manual", price: 5000, desc: "ç¿’å¾—é™£æ³•è¡“" },
        { id: "talisman_manual", price: 5000, desc: "ç¿’å¾—ç¬¦ç±™è¡“" },

        // === åŸºç¤ç”¢ç‰© ===
        { id: "qi_pill_fixed_large", price: 50, desc: "å›å¾©500çœŸæ°£" },
        { id: "mind_pill", price: 100, desc: "å¿ƒå¢ƒ+1" },
        { id: "comp_tea", price: 150, desc: "æ‚Ÿæ€§+1" },
        { id: "luck_charm", price: 200, desc: "æ°£é‹+1" },

        // === é€²éšç”¢ç‰© ===
        { id: "attack_pill_small", price: 300, desc: "æ”»æ“Š+2" },
        { id: "defense_pill_small", price: 300, desc: "é˜²ç¦¦+2" },

        // === å››è—ç›¸é—œææ–™ ===
        { id: "spirit_stone_small", price: 20, desc: "ä¸‹å“éˆçŸ³" }
    ];

    function openShop() {
        const modal = document.getElementById('shop-modal');
        const container = document.getElementById('shop-items-container');
        const contribDisplay = document.getElementById('shop-contrib-display');

        if (!modal || !container) return;

        // Access parent state safely
        const state = (window.parent && window.parent.gameState) || window.gameState;
        const contrib = state ? (state.factionContrib || 0) : 0;

        if (contribDisplay) contribDisplay.textContent = contrib;

        container.innerHTML = '';

        SectShopList.forEach(itemConfig => {
            const parentDB = window.parent.ItemDB;
            const itemDef = parentDB ? parentDB[itemConfig.id] : null;

            const name = itemDef ? itemDef.name : itemConfig.id;
            // Simple color fallback
            let color = '#333';
            if (itemDef) {
                switch (itemDef.rarity) {
                    case 'purple': color = '#9c27b0'; break;
                    case 'blue': color = '#2196f3'; break;
                    case 'green': color = '#4caf50'; break;
                    case 'orange': color = '#ff9800'; break;
                }
            }

            const div = document.createElement('div');
            div.style.border = '1px solid #d7ccc8';
            div.style.padding = '10px';
            div.style.borderRadius = '4px';
            div.style.background = '#efebe9';
            div.style.display = 'flex';
            div.style.flexDirection = 'column';
            div.style.justifyContent = 'space-between';

            div.innerHTML = `
                <div style="font-weight: bold; color: ${color}; margin-bottom: 4px;">${name}</div>
                <div style="font-size: 12px; color: #5d4037; margin-bottom: 8px;">${itemConfig.desc}</div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #d84315; font-weight: bold; font-size: 12px;">${itemConfig.price} è²¢ç»</span>
                    <button onclick="buySectItem('${itemConfig.id}', ${itemConfig.price})" 
                        style="padding: 4px 8px; background: #795548; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        å…Œæ›
                    </button>
                </div>
            `;
            container.appendChild(div);
        });

        modal.style.display = 'flex';
    }

    function buySectItem(itemId, price) {
        const state = (window.parent && window.parent.state) || window.state;
        if (!state) return;

        if ((state.factionContrib || 0) < price) {
            alert("å®—é–€è²¢ç»ä¸è¶³ï¼");
            return;
        }

        // æ‰£é™¤è²¢ç»
        state.factionContrib -= price;

        // æ·»åŠ ç‰©å“
        if (window.parent && window.parent.addItem) {
            window.parent.addItem(itemId, 1);
        } else {
            console.error("Cannot find addItem function in parent window");
            alert("è³¼è²·å¤±æ•—ï¼šç³»çµ±éŒ¯èª¤");
            return;
        }

        alert(`å…Œæ›æˆåŠŸï¼`);
        openShop(); // åˆ·æ–°é¡¯ç¤º

        // åŒæ­¥UI
        if (window.parent.renderUI) window.parent.renderUI();
        updateFactionUI(); // Update local display
    }

    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }

    // ===== è²¢ç»å ‚é‚è¼¯ =====
    function openContribHall() {
        const modal = document.getElementById('contrib-modal');
        if (modal) modal.style.display = 'flex';
        renderBountyList();
    }

    function switchContribTab(tab) {
        document.getElementById('contrib-section-bounty').style.display = (tab === 'bounty') ? 'block' : 'none';
        document.getElementById('contrib-section-minigame').style.display = (tab === 'minigame') ? 'block' : 'none';

        document.getElementById('tab-bounty').style.background = (tab === 'bounty') ? '#546e7a' : '#90a4ae';
        document.getElementById('tab-minigame').style.background = (tab === 'minigame') ? '#546e7a' : '#90a4ae';
    }

    function renderBountyList() {
        // Access state properly to check completion
        const pWin = window.parent || window;
        const state = pWin.gameState || pWin.state || window.state;

        const container = document.getElementById('bounty-list');
        if (!container || !window.ContributionHall) return;

        container.innerHTML = '';
        window.ContributionHall.bosses.forEach(boss => {
            const div = document.createElement('div');
            div.style.background = '#fff';
            div.style.padding = '10px';
            div.style.border = '1px solid #cfd8dc';
            div.style.borderRadius = '4px';
            div.style.display = 'flex';
            div.style.justifyContent = 'space-between';
            div.style.alignItems = 'center';

            // Calculate Approximate Real CP based on stats formula
            // New formula based on nerfed stats (HP*12, Atk*1, Def*0.2)
            // Approx weight: 12*0.8 + 1*5 + 0.2*3 = 9.6 + 5 + 0.6 = ~15.2
            // Base CP = Power * 15 + Crit/Luck offset (~50)
            const realCP = Math.floor(boss.power * 15 + 50);

            const isCompleted = state && state.completedChallenges && state.completedChallenges.includes(boss.id);
            const btnHtml = isCompleted
                ? `<button disabled style="padding:6px 12px; background:#78909c; color:#eceff1; border:none; border-radius:4px; cursor:not-allowed;">å·²å®Œæˆ</button>`
                : `<button onclick="ContributionHall.challengeBoss('${boss.id}')" style="padding:6px 12px; background:#bf360c; color:white; border:none; border-radius:4px; cursor:pointer;">æŒ‘æˆ°</button>`;

            div.innerHTML = `
                <div>
                    <div style="font-weight:bold; color:${isCompleted ? '#78909c' : '#d84315'};">${boss.name}</div>
                    <div style="font-size:12px; color:#546e7a;">${boss.desc}</div>
                    <div style="font-size:12px; margin-top:4px;">
                        <span>æˆ°åŠ›: ${realCP}</span> | 
                        <span style="color:${isCompleted ? '#90a4ae' : '#2e7d32'};">çå‹µ: ${boss.rewardStones} éˆçŸ³, ${boss.rewardContrib} è²¢ç», ${boss.rewardRep} è²æœ›</span>
                    </div>
                </div>
                ${btnHtml}
            `;
            container.appendChild(div);
        });
    }

    // DEBUG WRAPPER
    function debugChallenge(bossId) {
        alert("Debug: Button Clicked! Boss ID: " + bossId);
        if (window.ContributionHall) {
            window.ContributionHall.challengeBoss(bossId);
        } else {
            alert("Error: ContributionHall object not found!");
        }
    }

    // === æˆ°é¬¥è¿”å›è™•ç† (Battle Return Handler) ===
    (function checkBattleReturn() {
        // Wait for DOM and Scripts
        setTimeout(() => {
            const battleReturn = localStorage.getItem("battle-return-to");
            if (battleReturn === "contribution") {
                console.log("Returning from contribution battle...");

                const resultRaw = localStorage.getItem("battle-result");
                if (resultRaw) {
                    try {
                        const result = JSON.parse(resultRaw);
                        const bossId = result.bossId;

                        if (result.win) {
                            if (window.ContributionHall && window.ContributionHall.bosses) {
                                const boss = window.ContributionHall.bosses.find(b => b.id === bossId);
                                if (boss) {
                                    const pWin = window.parent || window;
                                    const state = pWin.gameState || pWin.state || window.state;

                                    if (state) {
                                        // Initialize completed list logic
                                        if (!state.completedChallenges) state.completedChallenges = [];

                                        // Check if already completed
                                        if (state.completedChallenges.includes(bossId)) {
                                            setTimeout(() => {
                                                alert(`ã€æˆ°é¬¥æ·å ±ã€‘\næ“Šæ•—äº† ${boss.name}ï¼\n(æ­¤æŒ‘æˆ˜å·²å®Œæˆï¼Œç„¡æ³•å†æ¬¡ç²å¾—çå‹µ)`);
                                            }, 100);
                                        } else {
                                            // First time clear logic
                                            state.completedChallenges.push(bossId);

                                            // Delay alert slightly to allow UI to render
                                            setTimeout(() => {
                                                alert(`ã€æˆ°é¬¥æ·å ±ã€‘\næ“Šæ•—äº† ${boss.name}ï¼\nç²å¾— ${boss.rewardStones} éˆçŸ³, ${boss.rewardContrib} è²¢ç», ${boss.rewardRep} è²æœ›ã€‚`);
                                            }, 100);

                                            // Awards
                                            if (window.addFactionContrib) {
                                                window.addFactionContrib(boss.rewardContrib);
                                            } else if (window.parent && window.parent.addFactionContrib) {
                                                window.parent.addFactionContrib(boss.rewardContrib);
                                            }

                                            // Add stones & Rep (Try accessing parent state)
                                            state.spiritStones = (state.spiritStones || 0) + boss.rewardStones; // fixed prop name
                                            state.factionRep = (state.factionRep || 0) + (boss.rewardRep || 0);

                                            // Update UI if available
                                            if (pWin.updateResourceUI) pWin.updateResourceUI();
                                            if (pWin.renderUI) pWin.renderUI();
                                            if (window.updateFactionUI) window.updateFactionUI();

                                            // Save
                                            if (pWin.GameStateManager) pWin.GameStateManager.save();
                                        }
                                    }
                                }
                            }
                        } else {
                            setTimeout(() => {
                                alert("ã€æŒ‘æˆ°å¤±æ•—ã€‘\nå‹æ•—ä¹ƒå…µå®¶å¸¸äº‹ï¼Œå°‘ä¿ è«‹é‡æ–°ä¾†éã€‚");
                            }, 100);
                        }
                    } catch (e) {
                        console.error("Error parsing battle result", e);
                    }

                    localStorage.removeItem("battle-result");
                }

                localStorage.removeItem("battle-return-to");

                // Re-open Hall
                openContribHall();
            }
        }, 500); // 500ms delay to ensure everything is loaded
    })();

    function challengeBoss(bossId) {
        const state = (window.parent && window.parent.state) || window.state;
        const boss = window.ContributionHall.bosses.find(b => b.id === bossId);
        if (!boss || !state) return;

        // ç°¡å–®æˆ°é¬¥è¨ˆç®—
        // ç©å®¶æˆ°åŠ›
        let playerPower = 0;
        if (typeof window.parent.calcBattlePower === 'function') {
            playerPower = window.parent.calcBattlePower();
        } else {
            // fallback
            playerPower = (state.attack * 2) + (state.defense * 2) + (state.hp / 10);
        }

        // ç°¡å–®åˆ¤å®šï¼šæˆ°åŠ› > 80% Boss æˆ°åŠ›å°±æœ‰æ©Ÿæœƒè´ï¼Œæˆ°åŠ› > Boss å¿…è´
        // åŠ å…¥éš¨æ©Ÿæ€§
        const winChance = Math.min(1.0, (playerPower / boss.power) * 0.8); // ç¨å¾®é›£ä¸€é»
        const roll = Math.random();

        if (playerPower > boss.power || roll < winChance) {
            // Win
            if (window.parent.addFactionContrib) {
                window.parent.addFactionContrib(boss.rewardContrib, `æ“Šæ•— ${boss.name}`);
            }
            if (window.parent.addResource) {
                // Assuming addResource exists or modify state direclty
                state.spiritStones += boss.rewardStones;
                if (window.parent.addLog) window.parent.addLog(`ç²å¾—æ‡¸è³éˆçŸ³ï¼š${boss.rewardStones}`, 'event');
            } else {
                state.spiritStones += boss.rewardStones;
            }

            alert(`æˆ°å‹äº† ${boss.name}ï¼\nç²å¾—è²¢ç» ${boss.rewardContrib}ï¼ŒéˆçŸ³ ${boss.rewardStones}`);
        } else {
            // Lose
            const dmg = Math.floor(state.maxHp * 0.3);
            state.hp -= dmg;
            if (state.hp < 0) state.hp = 0;
            if (window.parent.renderUI) window.parent.renderUI();

            if (window.parent.addLog) window.parent.addLog(`æŒ‘æˆ° ${boss.name} å¤±æ•—ï¼Œå—äº†é»è¼•å‚· (HP -${dmg})`, 'bad-event');
            alert(`å¦‚æœä¸æ•µ ${boss.name}ï¼Œç‹¼ç‹½é€ƒå›å®—é–€...\nç”Ÿå‘½æ¸›å°‘ ${dmg}`);
        }

        updateFactionUI();
    }

    function playGamble(choice) {
        const state = (window.parent && window.parent.state) || window.state;
        if (!state) {
            console.error("State not found in playGamble");
            alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ç©å®¶æ•¸æ“š");
            return;
        }

        // Read bet amount from input
        const inputEl = document.getElementById('gamble-bet');
        let cost = 10;
        if (inputEl) {
            cost = parseInt(inputEl.value);
        } else {
            // Fallback for safety
            cost = 10;
        }

        if (isNaN(cost) || cost < 10) {
            alert("ç„¡æ•ˆçš„ä¸‹æ³¨é‡‘é¡ï¼Œæœ€å°‘éœ€è¦ 10 éˆçŸ³ï¼");
            return;
        }

        if ((state.spiritStones || 0) < cost) {
            alert(`éˆçŸ³ä¸è¶³ï¼ä½ éœ€è¦ ${cost} éˆçŸ³ (ç•¶å‰: ${state.spiritStones || 0})`);
            return;
        }

        // Deduct cost
        state.spiritStones -= cost;

        const gameRes = window.ContributionHall.gamble(null, choice);

        const resDiv = document.getElementById('gamble-result');
        if (gameRes.win) {
            state.spiritStones += cost * 2;
            resDiv.innerHTML = `<span style="color:green">${gameRes.msg} (+${cost}éˆçŸ³)</span>`;
            if (window.parent.addLog) window.parent.addLog(`è³­åŠè´éŒ¢ï¼š${cost}éˆçŸ³`, 'event');
        } else {
            resDiv.innerHTML = `<span style="color:red">${gameRes.msg} (-${cost}éˆçŸ³)</span>`;
        }
        updateFactionUI();
        if (window.parent.renderUI) window.parent.renderUI();
    }

    function playRPS(myChoice) {
        // 0: scissors, 1: rock, 2: paper
        const state = (window.parent && window.parent.state) || window.state;
        if (!state) return;

        // Read bet amount
        const inputEl = document.getElementById('rps-bet');
        let cost = 10;
        if (inputEl) {
            cost = parseInt(inputEl.value);
        }

        if (isNaN(cost) || cost < 10) {
            alert("ç„¡æ•ˆçš„ä¸‹æ³¨é‡‘é¡ï¼Œæœ€å°‘éœ€è¦ 10 è²¢ç»ï¼");
            return;
        }

        if ((state.factionContrib || 0) < cost) {
            alert(`è²¢ç»ä¸è¶³ï¼ä½ éœ€è¦ ${cost} è²¢ç» (ç•¶å‰: ${state.factionContrib || 0})`);
            return;
        }

        // Deduct cost
        state.factionContrib -= cost;

        const res = window.ContributionHall.rps(myChoice);
        const resDiv = document.getElementById('rps-result');

        let color = '#333';
        let txt = '';

        if (res.result === 'win') {
            color = 'green';
            // Reward: Bet * 2
            const reward = cost * 2;
            state.factionContrib += reward;
            txt = `é•·è€å‡º${res.elderChoiceName}ï¼Œä½ è´äº†ï¼ (+${cost}è²¢ç»)`;
            if (window.parent.addLog) window.parent.addLog(`çŒœæ‹³ç²å‹ï¼š${cost}è²¢ç»`, 'event');
        } else if (res.result === 'lose') {
            color = 'red';
            txt = `é•·è€å‡º${res.elderChoiceName}ï¼Œä½ è¼¸äº†... (-${cost}è²¢ç»)`;
        } else {
            color = '#fbc02d';
            // Draw: Refund bet
            state.factionContrib += cost;
            txt = `é•·è€å‡º${res.elderChoiceName}ï¼Œå¹³æ‰‹ã€‚ (é€€é‚„ä¸‹æ³¨)`;
        }

        resDiv.innerHTML = `<span style="color:${color}">${txt}</span>`;
        updateFactionUI();
    }

    // 1. åŒæ­¥èˆ‡åˆå§‹åŒ–
    // é›–ç„¶ main.js æ˜¯çˆ¶è¦–çª—ï¼Œä½† iframe å…§çš„ JS ç’°å¢ƒæ˜¯ç¨ç«‹çš„ã€‚
    // é€™è£¡æˆ‘å€‘ä¸éœ€å¼·åˆ¶åŒæ­¥ç‰©ä»¶ï¼Œå› ç‚ºå¤§å®¶ç¾åœ¨éƒ½èµ° global vars + localStorageã€‚
    // ä½†ç‚ºäº†ç¢ºä¿é¡¯ç¤ºæ­£ç¢ºï¼Œæˆ‘å€‘å˜—è©¦å¾ parent è®€è®Šæ•¸ (å¦‚æœæœ‰çš„è©±) æˆ–è€… loadã€‚

    // å¦‚æœ parent å·²ç¶“è¼‰å…¥ state.js ä¸”æœ‰ globalsï¼Œæˆ‘å€‘å¯ä»¥è€ƒæ…®ç›´æ¥è®€ parent çš„ï¼Ÿ
    // ä½†ç‚ºäº†ç°¡å–®ï¼Œè®“ iframe ä¹Ÿè·‘è‡ªå·±çš„ state.js (å·²åœ¨ head é‚„æ˜¯å“ªè£¡è¼‰å…¥?)
    // æª¢æŸ¥: faction.html æ²’æœ‰è¼‰å…¥ state.js!
    // -> å¦‚æœæ²’æœ‰è¼‰å…¥ state.jsï¼Œé‚£ iframe è£¡æ ¹æœ¬æ²’æœ‰ GameStateManagerã€‚
    // -> å¿…é ˆç¢ºèª faction.html æ˜¯å¦æœ‰è¼‰å…¥ state.jsã€‚
    // å›é ­çœ‹ lines 1-800ï¼Œæ²’çœ‹åˆ° script src="state.js"ã€‚
    // å¦‚æœæ²’è¼‰å…¥ï¼Œé‚£ä¸Šé¢çš„ sync code ä»¥å‰æ˜¯æ€éº¼è·‘çš„ï¼Ÿ
    // "window.gameState = window.parent.gameState" -> å®ƒç›´æ¥ç”¨ parent çš„ç‰©ä»¶ã€‚
    // ç¾åœ¨ object æ²’äº†ï¼Œè®Šæ•¸åœ¨ parent window ä¸Šã€‚
    // æ‰€ä»¥ iframe å¿…é ˆç›´æ¥å­˜å– parent.variableã€‚
    // æˆ–è€… iframe è‡ªå·±è¼‰å…¥ state.jsã€‚

    // æª¢æŸ¥ line 954 ä¸‹é¢çš„ code.
    // çµè«–ï¼šfaction.html æ‡‰è©²åªæ˜¯ä¸€å€‹å°èˆªé ï¼Œä¸éœ€è¦é¡¯ç¤ºæ•¸å€¼ï¼Ÿ
    // å®ƒåªé¡¯ç¤º "åŠŸæ³•é–£" "æ¦®è­½å ‚"ã€‚
    // æ‰€ä»¥å…¶å¯¦ä¸éœ€è¦ stateã€‚
    // åªè¦èƒ½è·³è½‰å°±å¥½ã€‚

    // åˆªé™¤èˆŠçš„ sync blockï¼Œæ”¹ç‚ºæ–°çš„ updateUI
    console.log("âœ… Faction navigation loaded.");

    function updateFactionUI() {
        const state = (window.parent && window.parent.state) || window.state;
        if (!state) return;

        const fNameEl = document.getElementById('f-name');
        const fRankEl = document.getElementById('f-rank');
        const fContribEl = document.getElementById('f-contrib');
        const fStonesEl = document.getElementById('f-stones'); // New

        // Mapping faction IDs to Names (Simple check)
        let factionName = "ç„¡é–€ç„¡æ´¾";
        if (state.faction === 'qingyun') factionName = "é’é›²å®—";
        if (state.faction === 'moyun') factionName = "é­”é›²æ®¿"; // Add missing
        if (state.faction === 'danmeng') factionName = "ä¸¹ç›Ÿ"; // Add missing

        if (fNameEl) fNameEl.textContent = factionName;
        if (fRankEl) fRankEl.textContent = state.factionRank || "ç„¡";
        if (fContribEl) fContribEl.textContent = state.factionContrib || 0;
        if (fStonesEl) fStonesEl.textContent = state.spiritStones || 0;

        // Run validation in case balance changed
        validateGambleBet();
        validateRPSBet();
    }

    // Call on load
    window.addEventListener('load', updateFactionUI);
    // Also try immediately in case load event missed
    updateFactionUI();

    function validateGambleBet() {
        const state = (window.parent && window.parent.state) || window.state;
        const input = document.getElementById('gamble-bet');
        const error = document.getElementById('gamble-error');
        if (!state || !input || !error) return;

        const cost = parseInt(input.value) || 0;
        const owned = state.spiritStones || 0;

        if (cost > owned) {
            error.style.display = 'inline';
            error.textContent = `ä¸è¶³ (æ“æœ‰: ${owned})`;
        } else {
            error.style.display = 'none';
        }
    }

    function validateRPSBet() {
        const state = (window.parent && window.parent.state) || window.state;
        const input = document.getElementById('rps-bet');
        const error = document.getElementById('rps-error');
        if (!state || !input || !error) return;

        const cost = parseInt(input.value) || 0;
        const owned = state.factionContrib || 0;

        if (cost > owned) {
            error.style.display = 'inline';
            error.textContent = `ä¸è¶³ (æ“æœ‰: ${owned})`;
        } else {
            error.style.display = 'none';
        }

    }

    // 2. å°èˆªå‡½å¼
    function navigateTo(page) {
        if (window.parent && window.parent.document) {
            const frame = window.parent.document.getElementById("faction-frame");
            if (frame) {
                frame.src = page;
                return;
            }
        }
        window.location.href = page;
    }

    function goBook() {
        navigateTo("skill-hall.html");
    }

    function goHonor() {
        navigateTo("honor-hall.html");
    }

    function goPool() {
        navigateTo("xianling-pool.html");
    }

    // 3. é›–ç„¶æŒ‰éˆ•é‚è¼¯åœ¨ main.jsï¼Œä½†é€™è£¡ä¿ç•™å° iframe å…§éƒ¨å¯èƒ½çš„è¿”å›æŒ‰éˆ•è™•ç† (å¦‚æœæœ‰)
    // ç›®å‰ä¸»è¦ä¾è³´ index.html çš„æ‡¸æµ®æŒ‰éˆ•
</script>

</html>