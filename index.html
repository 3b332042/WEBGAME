<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8" />
    <title>修仙模擬 v0.1</title>
    <!-- 外部 CSS -->
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="faction-overlay" style="
    display:none;
    position:fixed;
    inset:0;
    background:#000;
    z-index:9999;
">
        <!-- 加一個 id="faction-frame" -->
        <iframe id="faction-frame" src="faction.html" style="width:100%; height:100%; border:none;"></iframe>

        <button id="btn-close-faction" style="
        position: absolute;
        top: 14px;
        left: 14px;
        padding: 6px 14px;
        font-size: 13px;
        border: 1px solid rgba(255, 245, 215, 0.55);
        border-radius: 6px;
        cursor: pointer;
        background: linear-gradient(to bottom, rgba(60,40,32,0.9), rgba(30,20,16,0.85));
        color: #f8e9c9;
        letter-spacing: 2px;
        box-shadow: 0 0 6px rgba(0,0,0,0.6), inset 0 0 4px rgba(255,255,255,0.08);
        z-index: 9999;
        backdrop-filter: blur(2px);
    ">
            返回修行界
        </button>

    </div>

    <!-- === 難度選擇彈窗背景 === -->
    <div id="difficulty-modal-bg" style="display:none;"></div>

    <!-- === 難度選擇彈窗 === -->
    <div id="difficulty-modal" style="display:none;">
        <div class="diff-title">選擇你的修行天賦</div>
        <div class="diff-desc">轉世輪迴，天道無常。請選擇此世的資質起點...</div>

        <div class="diff-options">
            <button class="difficulty-btn" data-root="1">
                <span class="btn-title">天靈根</span>
                <span class="btn-sub">單一屬性，修煉極快</span>
            </button>
            <button class="difficulty-btn" data-root="2">
                <span class="btn-title">雙靈根</span>
                <span class="btn-sub">兩種屬性，資質上乘</span>
            </button>
            <button class="difficulty-btn" data-root="3">
                <span class="btn-title">三靈根</span>
                <span class="btn-sub">三種屬性，凡人資質</span>
            </button>
            <button class="difficulty-btn" data-root="4">
                <span class="btn-title">四靈根</span>
                <span class="btn-sub">四種屬性，寸步難行</span>
            </button>
            <button class="difficulty-btn" data-root="5">
                <span class="btn-title">五靈根</span>
                <span class="btn-sub">五行雜駁，幾無仙緣</span>
            </button>
        </div>
    </div>

    <!-- 四藝視窗 -->
    <div id="arts-modal-bg" class="modal-bg"></div>
    <div id="arts-modal" class="modal">
        <div class="modal-header">
            <span>修仙四藝</span>
            <button id="arts-close-btn" class="close-btn">×</button>
        </div>
        <div class="modal-content">
            <div class="arts-tabs">
                <button class="arts-tab-btn active" data-type="alchemy">煉丹</button>
                <button class="arts-tab-btn" data-type="weapon">煉器</button>
                <button class="arts-tab-btn" data-type="formation">陣法</button>
                <button class="arts-tab-btn" data-type="talisman">符籙</button>
            </div>
            <div class="arts-info-panel">
                <span id="art-level-display">等級: 0</span>
                <span id="art-exp-display">經驗: 0/100</span>
            </div>
            <div id="arts-recipe-list" class="arts-list">
                <!-- Recipe items generated by JS -->
            </div>
        </div>
    </div>

    <!-- === 靈根測試彈窗 === -->
    <div id="root-test-bg" style="display:none;"></div>
    <div id="root-test-modal" style="display:none;">
        <div class="root-test-header">
            <span>靈根覺醒</span>
        </div>
        <div class="root-test-content">
            <div class="spirit-orb-container">
                <div class="spirit-orb"></div>
                <div class="orb-particles"></div>
            </div>
            <div id="root-roll-result" class="root-roll-result">
                檢測到你的靈魂波動...
            </div>
            <button id="btn-roll-root" class="difficulty-btn diff-roll">開始測試</button>
        </div>
    </div>

    <!-- === 商店彈窗背景 === -->
    <div id="shop-modal-bg" style="display:none;"></div>

    <!-- === 商店彈窗 === -->
    <div id="shop-modal" style="display:none;">
        <div id="shop-modal-header">
            <span>靈寶商店</span>
            <span id="shop-balance"
                style="flex: 1; text-align: right; margin-right: 15px; color: #ffd700; font-size: 14px;">💰 靈石：0</span>
            <button id="shop-close-btn">X</button>
        </div>

        <div id="shop-modal-content">
            <div id="shop-list"></div>
        </div>
    </div>

    <!-- === 飛升結算畫面 === -->
    <div id="ascension-victory-bg" style="display:none;"></div>
    <div id="ascension-victory-modal" style="display:none;">
        <div class="ascension-victory-header">
            <span>✨ 飛升成功 ✨</span>
        </div>
        <div class="ascension-victory-content">
            <div class="victory-section">
                <h3>最終數值</h3>
                <div class="victory-stats" id="victory-final-stats"></div>
            </div>
            <div class="victory-section">
                <h3>修煉歷程</h3>
                <div class="victory-timeline" id="victory-timeline"></div>
            </div>
        </div>
        <button id="victory-close-btn" class="victory-btn">重修此世</button>
    </div>

    <div id="app">
        <!-- ====== 上方標題列 ====== -->
        <div id="header">
            <div>🧘‍♂️ 修仙模擬 v0.1</div>
            <div id="header-info"></div>
        </div>

        <!-- ====== 左側：角色資訊 ====== -->
        <div id="left-panel">
            <!-- 角色資訊 -->
            <details class="info-section" open>
                <summary>角色資訊</summary>
                <div class="stat-line"><span class="stat-label">姓名：</span><span id="s-name"></span></div>
                <div class="stat-line"><span class="stat-label">年齡：</span><span id="s-age"></span> 歲</div>
                <div class="stat-line"><span class="stat-label">剩餘壽元：</span><span id="s-lifespan"></span> 歲</div>
                <div class="stat-line"><span class="stat-label">境界：</span><span id="s-realm"></span></div>
            </details>

            <!-- 屬性 -->
            <details class="info-section" open>
                <summary>屬性</summary>
                <div class="stat-line">
                    <span class="stat-label">真氣：</span><span id="s-qi"></span>
                </div>
                <div id="break-info-inline" style="font-size:12px; margin-left:6px; color:#ccc;"></div>
                <div class="stat-line">
                    <span class="stat-label">靈氣：</span><span id="s-mana"></span>
                </div>
                <div class="stat-line"><span class="stat-label">悟性：</span><span id="s-comp"></span></div>
                <div class="stat-line"><span class="stat-label">氣運：</span><span id="s-luck"></span></div>
                <div class="stat-line"><span class="stat-label">靈根：</span><span id="s-root"></span></div>
                <div class="stat-line"><span class="stat-label">心境：</span><span id="s-mind"></span></div>
                <div class="stat-line"><span class="stat-label">功法：</span><span id="s-technique"></span></div>
            </details>

            <!-- 戰鬥屬性 -->
            <details class="info-section">
                <summary>戰鬥屬性</summary>
                <div class="stat-line"><span class="stat-label">攻擊力：</span><span id="s-atk"></span></div>
                <div class="stat-line"><span class="stat-label">防禦力：</span><span id="s-def"></span></div>
                <div class="stat-line"><span class="stat-label">暴擊率：</span><span id="s-crit-rate"></span></div>
                <div class="stat-line"><span class="stat-label">暴擊傷害：</span><span id="s-crit-dmg"></span></div>
                <div class="stat-line"><span class="stat-label">血量：</span><span id="s-hp"></span></div>
                <div class="stat-line"><span class="stat-label">屬性攻擊：</span><span id="s-element-atk"></span></div>
                <div class="stat-line"><span class="stat-label">戰力：</span><span id="s-power"></span></div>
            </details>

            <!-- 裝備欄 -->
            <details class="info-section">
                <summary>裝備</summary>
                <div class="equipment-grid">
                    <div class="equipment-slot" data-slot="head">
                        <div class="slot-icon">👑</div>
                        <div class="slot-info">
                            <div class="slot-label">頭部</div>
                            <div class="slot-name" id="eq-head">未裝備</div>
                        </div>
                    </div>
                    <div class="equipment-slot" data-slot="body">
                        <div class="slot-icon">👘</div>
                        <div class="slot-info">
                            <div class="slot-label">衣服</div>
                            <div class="slot-name" id="eq-body">未裝備</div>
                        </div>
                    </div>
                    <div class="equipment-slot" data-slot="legs">
                        <div class="slot-icon">👖</div>
                        <div class="slot-info">
                            <div class="slot-label">褲子</div>
                            <div class="slot-name" id="eq-legs">未裝備</div>
                        </div>
                    </div>
                    <div class="equipment-slot" data-slot="feet">
                        <div class="slot-icon">👞</div>
                        <div class="slot-info">
                            <div class="slot-label">鞋子</div>
                            <div class="slot-name" id="eq-feet">未裝備</div>
                        </div>
                    </div>
                    <div class="equipment-slot" data-slot="weapon">
                        <div class="slot-icon">⚔️</div>
                        <div class="slot-info">
                            <div class="slot-label">法器</div>
                            <div class="slot-name" id="eq-weapon">未裝備</div>
                        </div>
                    </div>
                    <div class="equipment-slot" data-slot="formation">
                        <div class="slot-icon">🔮</div>
                        <div class="slot-info">
                            <div class="slot-label">陣法</div>
                            <div class="slot-name" id="eq-formation">未裝備</div>
                        </div>
                    </div>
                </div>
            </details>

            <!-- 資源 -->
            <details class="info-section" open>
                <summary>資源</summary>
                <div class="stat-line"><span class="stat-label">靈石：</span><span id="s-stone"></span></div>
            </details>

            <!-- 勢力 -->
            <details class="info-section" open>
                <summary>勢力</summary>
                <div class="stat-line" style="align-items:center;">
                    <span class="stat-label">所屬勢力：</span>
                    <span id="s-faction-name">無</span>
                    <button id="btn-enter-faction" onclick="openFaction();">
                        前往宗門
                    </button>
                </div>
                <div class="stat-line">
                    <span class="stat-label">聲望：</span><span id="s-faction-rep">0</span>
                </div>
                <div class="stat-line">
                    <span class="stat-label">位階：</span><span id="s-faction-rank">無</span>
                </div>
                <div class="stat-line">
                    <span class="stat-label">貢獻：</span><span id="s-faction-contrib">0</span>
                </div>
            </details>
        </div>

        <!-- ====== 中間：操作按鈕 ====== -->
        <div id="center-panel">
            <h2>修行操作</h2>
            <button id="btn-cultivate-1">閉關修煉 1 年</button>
            <button id="btn-cultivate-10">閉關修煉 10 年</button>
            <button id="btn-cultivate-100" style="display:none;">百年閉關（100 年）</button>
            <button id="btn-breakthrough">嘗試突破</button>
            <button id="btn-ascension" style="display:none;">飛升成仙</button>
            <button id="btn-toggle-arts" style="display:none;">四藝</button>
            <hr style="margin:8px 0; border-color:#444;">
            <button id="btn-toggle-inventory">背包</button>
            <button id="btn-toggle-shop">藏寶閣</button>
            <button id="btn-trial">歷練（暫時試劍山）</button>

            <hr style="margin:8px 0; border-color:#444;">
            <button id="btn-save">存檔（localStorage）</button>
            <button id="btn-load">讀檔</button>
            <button id="btn-reset">重修此世</button>
        </div>

        <!-- ====== 右邊：事件日誌 ====== -->
        <div id="right-panel">
            <h2>修行日誌</h2>
            <div id="log"></div>
        </div>
    </div>

    <!-- === 歷練彈窗背景 === -->
    <div id="trial-modal-bg" style="display:none;"></div>

    <!-- === 歷練彈窗 === -->
    <div id="trial-modal" style="display:none;">
        <div class="trial-header">
            <span>歷練</span>
            <button id="trial-close-btn">X</button>
        </div>

        <!-- 歷練列表視圖（表格式） -->
        <div id="trial-view-list">
            <table class="trial-table">
                <thead>
                    <tr>
                        <th>地點</th>
                        <th>風險</th>
                        <th>說明</th>
                    </tr>
                </thead>
                <tbody>
                    <tr data-trial-id="sword_mountain">
                        <td>試劍山</td>
                        <td>中</td>
                        <td>劍意縱橫，適合磨鍊心性與劍道。</td>
                    </tr>
                    <tr data-trial-id="beast_forest">
                        <td>妖獸林</td>
                        <td>高</td>
                        <td>妖獸出沒，危機四伏，但也有不少戰鬥機緣。</td>
                    </tr>
                    <tr data-trial-id="cold_cave">
                        <td>寒潭洞窟</td>
                        <td>中</td>
                        <td>陰寒之地，適合磨練意志，但稍有不慎便會凍傷元氣。</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 劇情視圖（分支選項都在這裡進行） -->
        <div id="trial-view-story" style="display:none;">
            <h3 id="trial-story-title"></h3>
            <div id="trial-story-text" class="trial-story-text"></div>
            <div id="trial-story-choices" class="trial-story-choices"></div>

            <button id="trial-back-btn">返回歷練列表</button>
        </div>
    </div>

    <!-- === 背包彈窗背景 === -->
    <div id="inventory-modal-bg" style="display:none;"></div>

    <!-- === 背包彈窗 === -->
    <div id="inventory-modal" style="display:none;">
        <div id="inventory-modal-header">
            <span>背包</span>
            <button id="inventory-close-btn">X</button>
        </div>

        <div id="inventory-modal-content">
            <div id="inventory-list"></div>
        </div>
    </div>

    <!-- === 四藝彈窗 === -->
    <div id="arts-modal-bg" class="modal-bg" style="display:none;"></div>
    <div id="arts-modal" class="modal" style="display:none;">
        <div class="modal-header">
            <span>修真百藝</span>
            <button id="arts-close-btn">X</button>
        </div>
        <div class="modal-content">
            <div class="arts-info-panel">
                <div id="art-level-display"></div>
                <!-- Exp bar container will be inserted here by JS -->
                <div id="art-exp-display" style="display:none;"></div>
            </div>

            <div class="arts-tabs">
                <button class="arts-tab-btn active" data-type="alchemy">煉丹</button>
                <button class="arts-tab-btn" data-type="weapon">煉器</button>
                <button class="arts-tab-btn" data-type="formation">陣法</button>
                <button class="arts-tab-btn" data-type="talisman">符籙</button>
                <button class="arts-tab-btn" data-type="smelting" style="color: #ffd700;">熔煉</button>
            </div>

            <div id="arts-recipe-list" class="arts-list"></div>
        </div>
    </div>


    <!-- Debug Button (Bottom Right) -->
    <div id="debug-btn" onclick="DebugController.toggle()"
        style="display: none; position: fixed; bottom: 10px; right: 10px; z-index: 9999; background: #d32f2f; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; opacity: 0.7;">
        DEBUG
    </div>

    <!-- Debug Console Modal -->
    <div id="debug-console"
        style="display: none; position: fixed; top: 10%; right: 10px; width: 300px; max-height: 80vh; overflow-y: auto; background: rgba(0,0,0,0.9); color: #fff; padding: 15px; border-radius: 8px; z-index: 10000; border: 1px solid #555;">
        <h3 style="margin-top:0; border-bottom: 1px solid #555; padding-bottom: 5px;">控制台</h3>

        <div style="margin-bottom: 10px;">
            <label>靈石 (+1000)</label>
            <button onclick="DebugController.addResource('stones', 1000)">Add</button>
        </div>
        <div style="margin-bottom: 10px;">
            <label>宗門貢獻 (+500)</label>
            <button onclick="DebugController.addResource('contrib', 500)">Add</button>
        </div>
        <div style="margin-bottom: 10px;">
            <label>真氣 (+1000)</label>
            <button onclick="DebugController.addResource('qi', 1000)">Add</button>
        </div>

        <hr style="border-color: #444;">

        <div style="margin-bottom: 5px;">
            <label>境界等級:</label>
            <input type="number" id="dbg-realm" style="width: 50px;" placeholder="Lv">
            <button
                onclick="DebugController.setAttribute('realm', document.getElementById('dbg-realm').value)">Set</button>
        </div>
        <div style="margin-bottom: 5px;">
            <label>壽元:</label>
            <input type="number" id="dbg-life" style="width: 50px;" placeholder="Year">
            <button
                onclick="DebugController.setAttribute('lifespan', document.getElementById('dbg-life').value)">Set</button>
        </div>
        <div style="margin-bottom: 5px;">
            <label>根骨/悟性/心境 (+10)</label>
            <button
                onclick="DebugController.setAttribute('comprehension', (window.state.comprehension||0)+10)">悟+10</button>
            <button onclick="DebugController.setAttribute('mindset', (window.state.mindset||0)+10)">心+10</button>
        </div>

        <hr style="border-color: #444;">

        <div style="margin-bottom: 5px;">
            <label>四藝等級:</label>
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <input type="number" id="dbg-art-level" style="width: 40px;" placeholder="Lv">
                <button
                    onclick="DebugController.setArtLevel('alchemy', document.getElementById('dbg-art-level').value)">丹</button>
                <button
                    onclick="DebugController.setArtLevel('weapon', document.getElementById('dbg-art-level').value)">器</button>
                <button
                    onclick="DebugController.setArtLevel('formation', document.getElementById('dbg-art-level').value)">陣</button>
                <button
                    onclick="DebugController.setArtLevel('talisman', document.getElementById('dbg-art-level').value)">符</button>
            </div>
            <button onclick="DebugController.unlockAllArts()">解鎖全部四藝</button>
        </div>

        <hr style="border-color: #444;">

        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
            <button onclick="DebugController.triggerRandomEvent()">隨機事件</button>
            <button onclick="DebugController.triggerSectEvent()">宗門事件(+500)</button>
            <button onclick="DebugController.fullHeal()">恢復狀態</button>
        </div>

        <hr style="border-color: #444;">
        <div style="margin-bottom: 5px; display: flex; gap: 5px;">
            <button onclick="DebugController.joinFaction('qingyun')">加入青雲(Debug)</button>
            <button onclick="DebugController.joinFaction('none')">退出宗門</button>
        </div>

        <div style="text-align: right; margin-top: 10px;">
            <span onclick="DebugController.toggle()"
                style="cursor: pointer; color: #aaa; text-decoration: underline;">Close</span>
        </div>
    </div>

    <!-- JS 模組載入順序 -->
    <script src="realms.js"></script>
    <script src="state.js"></script>
    <script src="items.js"></script>
    <script src="root.js"></script>
    <script src="battle.js"></script>
    <script src="events.js"></script>
    <script src="materials.js"></script>
    <script src="trial.js"></script>
    <script src="shop.js"></script>
    <script src="inventory.js"></script>
    <script src="faction.js"></script>
    <script src="trial_rewards.js"></script>
    <script src="sword_mountain.js"></script>
    <script src="faction_data.js"></script>
    <script src="arts.js"></script>
    <script src="smelting.js"></script>

    <!-- UI Module -->
    <script src="ui.js"></script>
    <script src="debug.js"></script>

    <!-- ⭐ main.js 必須最後載入，否則初始化會出錯 -->
    <script src="main.js"></script>
</body>

</html>